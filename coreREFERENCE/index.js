// @bun
import{e as $}from"../chunk-yyha2fsa.js";import{h as l,j as p,m as w,n as v}from"../chunk-2hg32mwe.js";function D(i,n,r,t,s){let e={port:i,hostname:n,reusePort:r,fetch:(o)=>s.handleRequest(o)};if(t)e.tls={cert:Bun.file(t.cert),key:Bun.file(t.key),ca:t.ca?t.ca.map((o)=>Bun.file(o)):void 0};return e}function I(i){return Number.isInteger(i)&&i>=1&&i<=65535}function V(i){return typeof i==="string"&&i.length>4}async function O(i,n=3000,r="localhost",t,s){if(typeof Bun.serve!=="function")throw new l({code:"SERVER_NOT_AVAILABLE",message:"Bun.serve is not available in this environment.",details:{environment:"development"}});if(!I(n)||!V(r)){let e=`Invalid hostname: ${r} or port number: ${n}. Port must be an integer between 1 and 65535.`;throw new l({code:"INVALID_PORT_OR_HOSTNAME",message:e,details:{port:n,hostname:r}})}try{let e=D(n,r,t,s,i),o=Bun.serve(e);return{port:o.port,hostname:o.hostname}}catch(e){throw new l({code:"SERVER_ERROR",message:"An error occurred while starting the server."})}}var P=(...i)=>{let n=i.flatMap((r)=>{return r.split("/").filter(Boolean)}).join("/").replace(/\/+/g,"/").replace(/^\/|\/$/g,"");return n?`/${n}`:"/"};function d(i){if(typeof i!=="string")throw new TypeError("Path must be a string");if(i=i.trim(),i==="")return"/";if(i=i.replace(/\/+/g,"/"),i=i==="/"?"/":i.replace(/\/$/,""),!i.startsWith("/"))i="/"+i;return i=i.split("/").map((n)=>encodeURIComponent(decodeURIComponent(n))).join("/"),i}class S{children=new Map;route=null;isParam=!1;paramName="";isOptional=!1;isWildcard=!1;regex=null}class b{capacity;head=null;tail=null;size=0;cache=new Map;constructor(i){this.capacity=i}get(i){let n=this.cache.get(i);if(!n)return;if(n!==this.head)this._unlink(n),this._link(n);return n.value}set(i,n){if(this.cache.has(i)){let t=this.cache.get(i);if(t.value=n,t!==this.head)this._unlink(t),this._link(t);return}if(this.size>=this.capacity){let t=this.tail;this.cache.delete(t.key),this._unlink(t)}let r=new B(i,n);this._link(r),this.cache.set(i,r),this.size=Math.min(this.size+1,this.capacity)}has(i){return this.cache.has(i)}clear(){this.cache.clear(),this.head=null,this.tail=null,this.size=0}_link(i){if(this.head)i.next=this.head,this.head.prev=i,this.head=i;else this.head=this.tail=i}_unlink(i){let{prev:n,next:r}=i;if(n)n.next=r;else this.head=r;if(r)r.prev=n;else this.tail=n}}class B{i;n;r;t;constructor(i,n,r,t){this.key=i;this.value=n;this.prev=r;this.next=t}}var y={TRAILING_SLASH:/\/+$/,WILDCARD_END:/\/\*$/,OPTIONAL_PARAM:/\/:(\w+)\?/g,PARAM:/\/:(\w+)(\([^)]+\))?/g,KEY_MATCH:/\/:([\w?]+)/g,DIGIT:/^\d+$/,ALPHA:/^[a-zA-Z]+$/,ALPHANUMERIC:/^[a-zA-Z0-9]+$/};class C{root=new S;routeCache;regexCache;constructor(){this.routeCache=new b(1e4),this.regexCache=new b(200)}parseRegexRoute(i){let n=this.regexCache.get(i);if(n)return n;let r=[],t=i.replace(y.TRAILING_SLASH,"").replace(y.WILDCARD_END,"/(.*)");if(t=t.replace(y.OPTIONAL_PARAM,(s,e)=>{return r.push(e),`(?:/(?<${e}>[^/]+))?`}),t=t.replace(y.PARAM,(s,e,o)=>{if(r.push(e),o){let g=o.slice(1,-1).replace(/\\/g,"\\");return`/(?<${e}>${g})`}else{let g=y[e.toUpperCase()];if(g)return`/(?<${e}>${g.source})`;return`/(?<${e}>[^/]+)`}}),i.endsWith("*"))r.push("wildcard"),t+="(?<wildcard>.*)";return this.regexCache.set(i,{pattern:t,keys:r}),{pattern:t,keys:r}}createRoute(i,n,r,t,s=new Set){return{method:i,handler:r,originalPath:n,optionalParams:new Set,regex:void 0,keys:s,path:n,params:new Map,middleware:t}}addRoute(i,n,r,t=[]){let{pattern:s,keys:e}=this.parseRegexRoute(n),o=n.split("/").filter(Boolean),g=this.root;for(let a of o){let u=a.startsWith(":"),c=a==="*",h=a.endsWith("?"),f=g.children.get(u||c?"*":a)??this.ensureChildNode(g,u||c?"*":a);if(u||c)f.paramName=a.slice(1).replace("?","");f.isParam=u,f.isWildcard=c,f.isOptional=h,g=f}if(g.route=this.createRoute(i,n,r,t,new Set(e)),g.regex=new RegExp(`^${s}\$`),n==="/")this.root.route=g.route;return this}findRoute(i,n){let r=`${i}:${n}`,t=this.routeCache.get(r);if(t)return t;let s=d(n);if(s==="/"){if(this.root.route&&this.root.route.method===i){let u={route:this.root.route,params:new Map};return this.routeCache.set(r,u),u}return}let e=s.split("/").filter(Boolean),o=new Map,g=this.root;for(let u=0;u<e.length;u++){let c=e[u],h=g.children.get(c)||g.children.get("*")||g.children.get("**");if(h){if(g=h,h.isParam)o.set(h.paramName,c);else if(h.isWildcard){o.set("wildcard",e.slice(u).join("/"));break}}else{let f=Array.from(g.children.values()).find((E)=>E.isOptional);if(f)g=f,u--;else return}}if(g.route&&g.route.method===i){let u={route:g.route,params:o};return this.routeCache.set(r,u),u}let a=Array.from(g.children.values()).find((u)=>u.isOptional&&u.route?.method===i);if(a){let u={route:a.route,params:o};return this.routeCache.set(r,u),u}return}getRoutes(){let i=[],n=(r,t="")=>{if(r.route)i.push(r.route);for(let[s,e]of r.children){let o=t+(s==="*"?"/:"+e.paramName:"/"+s);n(e,o)}};return n(this.root),i}async handleRequest(i,n,r){try{let t=`${n}:${d(i)}`,s=this.routeCache.get(t);if(!s){if(s=this.findRoute(n,i),s)this.routeCache.set(t,s)}if(s)return r.setParams(Object.fromEntries(s.params)),this.runMiddlewareAndHandler(s.route,r);return r.notFound()}catch(t){return console.error("Error handling request:",t),r.notFound()}}ensureChildNode(i,n){let r=i.children.get(n);if(!r)r=new S,i.children.set(n,r);return r}async runMiddlewareAndHandler(i,n){for(let t of i.middleware)await t(n,()=>Promise.resolve());let r=await i.handler(n);return this.processHandlerResult(n,r)}processHandlerResult(i,n){if(n instanceof Response)return n;if(typeof n==="string")return this.isHtml(n)?i.html(n):i.text(n);if(typeof n==="object")return i.json(n);return}isHtml=(()=>{let i=/<!DOCTYPE html>|<html>|<head>|<body>|<div>/;return(n)=>i.test(n.trim())})()}class T{request;_params;_pathname=null;_bodyUsed=!1;constructor(i){this.request=i,this._params=new URL(i.url).searchParams}assertBodyNotUsed(){if(this._bodyUsed)throw new Error("Request body has already been read");this._bodyUsed=!0}get method(){return this.request.method}get url(){return this.request.url}get headers(){return new Headers(this.request.headers)}param(i){return this._params.get(i)}query(){let i={};return this._params.forEach((n,r)=>{if(r in i)if(Array.isArray(i[r]))i[r].push(n);else i[r]=[i[r],n];else i[r]=n}),i}getParams(...i){return Object.fromEntries(i.map((n)=>[n,this._params.get(n)]))}reqHeader(i){return this.request.headers.get(i)}reqAllHeaders(){let i={};return this.request.headers.forEach((n,r)=>{i[r]=n}),i}getPathname(){if(this._pathname===null)this._pathname=new URL(this.request.url).pathname;return this._pathname}getContentType(){return this.reqHeader("content-type")}async getBody(){this.assertBodyNotUsed();let i=this.reqHeader("content-type");if(!i)return null;try{if(i.includes("application/json"))return await this.request.json();if(i.includes("application/x-www-form-urlencoded")||i.includes("multipart/form-data"))return await this.request.formData();if(i.includes("text/"))return await this.request.text();return await this.request.arrayBuffer()}catch(n){throw console.error("Error parsing request body:",n),new Error("Failed to parse request body")}}hasHeader(i){return this.request.headers.has(i)}hasBody(){return["POST","PUT","PATCH","DELETE"].includes(this.method.toUpperCase())}hasParam(i){return this._params.has(i)}}import{createHmac as _}from"crypto";class q{request;response;parsedCookies=null;signingStrategies;verifyStrategies;constructor(i,n){this.request=i,this.response=n,this.signingStrategies=new Map([["hmac",this.hmacSign.bind(this)]]),this.verifyStrategies=new Map([["hmac",this.hmacVerify.bind(this)]])}set(i,n,r={}){let t=this.mergeOptions(r),s=n;if(r.signing)s=this.signValue(n,r.signing);let e=this.serialize(i,s,t);return this.setCookieHeader(e)}get(i,n){this.ensureParsedCookies();let r=this.parsedCookies?.get(i)??null;if(r&&n?.signing)return this.verifyValue(r,n.signing);return r}delete(i,n={}){return this.set(i,"",{...n,maxAge:0})}registerSigningStrategy(i,n){this.signingStrategies.set(i,n)}registerVerifyStrategy(i,n){this.verifyStrategies.set(i,n)}mergeOptions(i){return{path:"/",httpOnly:!0,secure:!0,sameSite:"Lax",...i}}signValue(i,n){if(n.type==="jwt"&&typeof n.jwtSign==="function")return n.jwtSign(i,n.secret,n.jwtOptions);let r=this.signingStrategies.get(n.type);if(!r)throw new Error(`Unsupported signing type: ${n.type}`);return r(i,n.secret,n.jwtOptions)}verifyValue(i,n){if(n.type==="jwt"&&typeof n.jwtVerify==="function")return n.jwtVerify(i,n.secret);let r=this.verifyStrategies.get(n.type);if(!r)throw new Error(`Unsupported verification type: ${n.type}`);return r(i,n.secret)}serialize(i,n,r){let t=[`${i}=${encodeURIComponent(n)}`];if(r.maxAge!==void 0)t.push(`Max-Age=${r.maxAge}`);if(r.domain)t.push(`Domain=${r.domain}`);if(t.push(`Path=${r.path}`),r.secure)t.push("Secure");if(r.httpOnly)t.push("HttpOnly");if(r.sameSite)t.push(`SameSite=${r.sameSite}`);if(r.expires)t.push(`Expires=${r.expires.toUTCString()}`);return t.join("; ")}setCookieHeader(i){try{return this.response.appendHeader("Set-Cookie",i),!0}catch(n){return console.error("Failed to set cookie:",n),!1}}ensureParsedCookies(){if(this.parsedCookies===null)this.parseCookies()}parseCookies(){let i=this.request.reqHeader("cookie");if(this.parsedCookies=new Map,i)i.split(";").forEach((n)=>{let[r,...t]=n.trim().split("=");this.parsedCookies.set(r,decodeURIComponent(t.join("=")))})}hmacSign(i,n){let r=_("sha256",n).update(i).digest("base64").replace(/=+$/,"");return`${i}.${r}`}hmacVerify(i,n){let[r,t]=i.split(".");if(!r||!t)return null;let s=this.hmacSign(r,n).split(".")[1];return t===s?r:null}}class R{req;res;cookieManager;params;locals;constructor(i){this.req=new T(i),this.res=new v,this.params={},this.locals=new Map,this.cookieManager=new q(this.req,this.res)}setCookie(i,n,r){this.cookieManager.set(i,n,r)}getCookie(i,n){return this.cookieManager.get(i,n)}delCookie(i,n){this.cookieManager.delete(i,n)}validateKey=(i)=>{if(typeof i!=="string")throw new TypeError("Invalid key: must be a string");let n=i.trim();if(n.length===0)throw new RangeError("Invalid key: must be a non-empty string");if(n.length>100)throw new RangeError("Invalid key: must not be longer than 100 characters");if(/[\x00-\x1F\x7F]/.test(n))throw new Error("Invalid key: must not contain control characters");if(!/^[a-zA-Z0-9_.-]+$/.test(n))throw new Error("Invalid key: must only contain alphanumeric characters, underscores, dots, or hyphens");return n};set(i,n){let r=this.validateKey(i);this.locals.set(r,{type:typeof n,value:n})}get(i){let n=this.validateKey(i),r=this.locals.get(n);if(r)return r.value;return}has(i){let n=this.validateKey(i);return this.locals.has(n)}delete(i){let n=this.validateKey(i);this.locals.delete(n)}getAll(){return new Map(this.locals)}getAllKeys(){return Array.from(this.locals.keys())}setParam(i,n){this.params[i]=n}setParams(i){this.params=i}getParam(i){return this.params[i]}getAllParams(){return this.params}getResponse(){return this.res.getResponse()}setResponse(i){return this.res.setResponse(i),this}updateResponse(i){this.res.updateResponse(i)}getMethod(){return this.req.method}getUrl(){return this.req.url}getHeaders(){return this.req.headers}param(i){return this.req.param(i)}query(){return this.req.query()}getParams(...i){return this.req.getParams(...i)}reqHeader(i){return this.req.reqHeader(i)}reqAllHeaders(){return this.req.reqAllHeaders()}getPathname(){return this.req.getPathname()}getContentType(){return this.req.getContentType()}getBody(){return this.req.getBody()}hasHeader(i){return this.req.hasHeader(i)}hasBody(){return this.req.hasBody()}hasParam(i){return this.req.hasParam(i)}json(i,n){let r=this.res.json(i,n);return this.setResponse(r),r}text(i,n){let r=this.res.text(i,n);return this.setResponse(r),r}html(i,n){let r=this.res.html(i,n);return this.setResponse(r),r}redirect(i,n){let r=this.res.redirect(i,n);return this.setResponse(r),r}notFound(i="404 Not Found",n){let r=this.res.notFound(i,n);return this.setResponse(r),r}badRequest(i="Bad Request"){let n=this.res.badRequest(i);return this.setResponse(n),n}serverError(i="Internal Server Error"){let n=this.res.serverError(i);return this.setResponse(n),n}created(i,n){let r=this.res.created(i,n);return this.setResponse(r),r}file(i,n,r){let t=this.res.file(i,n,r);return this.setResponse(t),t}formData(i,n){let r=this.res.formData(i,n);return this.setResponse(r),r}stream(i,n){let r=this.res.stream(i,n);return this.setResponse(r),r}appendHeader(i,n){this.res.appendHeader(i,n)}setHeader(i,n){this.res.setHeader(i,n)}setHeaders(i){this.res.setHeaders(i)}getHeader(i){return this.res.getHeader(i)}getAllHeaders(){return this.res.getAllHeaders()}removeHeader(i){this.res.removeHeader(i)}noContent(i){let n=this.res.noContent(i);return this.setResponse(n),n}getStatus(){return this.res.getStatus()}}class H{preRoutingMiddlewares=new Map;postRoutingMiddlewares=new Map;async runPreRoutingMiddlewares(i){await this.runMiddlewares(i,this.preRoutingMiddlewares)}async runPostRoutingMiddlewares(i){await this.runMiddlewares(i,this.postRoutingMiddlewares)}use(i,...n){let r="/",t,s="pre";if(typeof i==="string")r=i,t=n.filter((g)=>typeof g!=="string");else if(Array.isArray(i))t=i;else t=[i];let e=n[n.length-1];if(typeof e==="string")s=e;let o=s==="pre"?this.preRoutingMiddlewares:this.postRoutingMiddlewares;if(t.length>1){let g=this.createGroupedMiddleware(t);return this.addMiddleware(o,r,g)}else return this.addMiddleware(o,r,...t)}useWhen(i,...n){let r=async(t,s)=>{if(i(t))await this.createGroupedMiddleware(n)(t,s);else await s()};return this.use(r)}createGroupedMiddleware(i){return async(n,r)=>{let t=-1,s=async(e)=>{if(e<=t)throw new p("next() called multiple times");t=e;let o=i[e];if(o)await o(n,()=>s(e+1));else await r()};await s(0)}}addMiddleware(i,n,...r){if(!i||!n||!r||r.length===0)throw console.error("Failed to add middleware:",n,r),new p("Failed to add middleware");if(!i.has(n))i.set(n,[]);let t=i.get(n);if(!t)throw new l({message:"Failed to get middleware for path",status:500,code:"MIDDLEWARE_ERROR",details:{path:n}});return t.push(...r),this}createNext(i,n){let r=new URL(i.getUrl()).pathname,t=Array.from(n.keys()).filter((g)=>r.startsWith(g)).sort((g,a)=>a.length-g.length),s=0,e=0,o=async()=>{while(s<t.length){let g=t[s],a=n.get(g);if(e<a.length){let u=a[e];e++,await u(i,o);return}s++,e=0}};return o}getMiddlewares(i="pre"){let n=i==="pre"?this.preRoutingMiddlewares:this.postRoutingMiddlewares,r=[];for(let[t,s]of n)for(let e of s)r.push({path:t,handler:e});return r}async runMiddlewares(i,n){if(await this.createNext(i,n)(),i.getResponse())return}}class m{i;plugins=new Map;namespaces=new Map;dependencyGraphCache=null;pluginAPI;currentInstallingPlugin=null;constructor(i){this.app=i;this.pluginAPI=this.createPluginAPI()}isPluginInstalled=(i)=>this.plugins.get(i)?.installed??!1;getInstalledPlugins=()=>Array.from(this.plugins.values()).filter(({installed:i})=>i).map(({plugin:i})=>i);getPluginDependencyGraph=()=>{if(!this.dependencyGraphCache)this.dependencyGraphCache=Object.fromEntries(Array.from(this.plugins.values(),({plugin:i})=>[i.name,i.dependencies??[]]));return this.dependencyGraphCache};getPluginMetadata=(i)=>this.plugins.get(i)?.plugin;invalidateDependencyGraphCache=()=>{this.dependencyGraphCache=null};isVersionCompatible=(i,n)=>{let[r,t,s]=i.split(".").map(Number),[e,o,g]=n.split(".").map(Number);return r>e||r===e&&(t>o||t===o&&s>=g)};createPluginAPI(){return{addMiddleware:this.app.use.bind(this.app),extendContext:(i)=>{Object.assign(R.prototype,i)},registerNamespace:this.registerNamespace,isPluginInstalled:this.isPluginInstalled,getInstalledPlugins:this.getInstalledPlugins,getPluginDependencyGraph:this.getPluginDependencyGraph,getPluginNamespaces:this.getPluginNamespaces,getAllNamespaces:this.getAllNamespaces,isPluginRegistered:this.isPluginRegistered,namespaceExists:this.namespaceExists}}registerNamespace=(i,n)=>{if(this.namespaces.has(i))throw new l({message:`Namespace "${i}" is already registered.`,details:{namespace:i}});if(this.namespaces.set(i,n),this.currentInstallingPlugin)this.plugins.get(this.currentInstallingPlugin)?.namespaces.push(i)};async installPlugin(i,n,r=new Set){let t=this.plugins.get(i);if(!t||t.installed)return;if(r.has(i))throw new l({message:`Circular dependency detected: ${Array.from(r).join(" -> ")} -> ${i}`,details:{circularDependency:Array.from(r).join(" -> ")+" -> "+i}});r.add(i);let{plugin:s}=t;await this.installDependencies(s,i,r);try{this.currentInstallingPlugin=i,await s.install(this.app,this.pluginAPI,n),t.installed=!0,this.invalidateDependencyGraphCache()}catch(e){if(e instanceof l)throw e;throw w(e)}finally{this.currentInstallingPlugin=null,r.delete(i)}}async installDependencies(i,n,r){if(!i.dependencies)return;for(let t of i.dependencies){let s=this.plugins.get(t.name);if(!s){if(t.optional){console.warn(`Optional dependency "${t.name}" for plugin "${n}" is not registered.`);continue}throw new l({message:`Dependency "${t.name}" for plugin "${n}" is not registered.`,details:{plugin:n,dependency:t.name}})}if(t.version){let e=s.plugin.version;if(e&&!this.isVersionCompatible(e,t.version))throw new l({message:`Dependency "${t.name}" for plugin "${n}" is not compatible with installed version "${e}".`,details:{plugin:n,dependency:t.name,installedVersion:e,requiredVersion:t.version}})}await this.installPlugin(t.name,void 0,new Set(r))}}async plugin(i,n){if(this.plugins.has(i.name)){console.warn(`Plugin "${i.name}" is already registered.`);return}this.plugins.set(i.name,{plugin:i,installed:!1,namespaces:[]}),await this.installPlugin(i.name,n)}usePlugin=(i)=>{let n=this.namespaces.get(i);if(!n)throw new l({message:`Namespace "${i}" is not registered.`,details:{namespace:i}});return n};async uninstallPlugin(i){let n=this.plugins.get(i);if(!n||!n.installed)throw new l({message:`Plugin "${i}" is not installed.`,details:{plugin:i}});if(n.plugin.uninstall)await n.plugin.uninstall(this.app);n.installed=!1,n.namespaces.forEach((r)=>this.namespaces.delete(r)),n.namespaces=[],this.invalidateDependencyGraphCache()}namespaceExists=(i)=>this.namespaces.has(i);isPluginRegistered=(i)=>this.plugins.has(i);getAllNamespaces=()=>Array.from(this.namespaces.keys());getPluginNamespaces=(i)=>this.plugins.get(i)?.namespaces||[]}class A{router;pluginManager;middlewareHandler=new H;constructor(i={}){if(this.router=new C,this.pluginManager=new m(this),this.middlewareHandler=new H,i.errorHandler!==!1)this.use($)}addRoute(i,n,...r){let t=r.slice(0,-1),s=r[r.length-1];return this.router.addRoute(i,n,s,t),this}handleRouteHandler(i){let n=Object.keys(i);for(let r of n){let t=i[r];if(Array.isArray(t)){let[s,...e]=t;this.addRoute(r,s,...e)}else if(typeof t==="string")this.addRoute(r,t,()=>new Response("Not Implemented",{status:501}))}}async handleRequest(i){let n=new R(i);try{if(await this.middlewareHandler.runPreRoutingMiddlewares(n),n.getResponse())return n.getResponse();let r=await this.router.handleRequest(n.getPathname(),n.getMethod(),n);if(!r)return n.notFound();return n.setResponse(r),await this.middlewareHandler.runPostRoutingMiddlewares(n),n.getResponse()}catch(r){return n.notFound()}}plugin(i,n){return this.pluginManager.plugin(i,n),this}usePlugin(i){return this.pluginManager.usePlugin(i)}use(i,...n){return this.middlewareHandler.use(i,...n),this}useWhen(i,...n){return this.middlewareHandler.useWhen(i,...n),this}route(i,...n){if(n.length===0)throw new p("No sub apps provided");if(!n.every((t)=>t instanceof A))throw new p("Invalid sub app provided",{code:"INVALID_SUB_APP",details:{subApps:n.map((t)=>typeof t)}});let r=P(i);return n.forEach((t)=>{t.router.getRoutes().forEach((s)=>{let e=P(r,s.originalPath);this.router.addRoute(s.method,e,s.handler,s.middleware||[])}),t.middlewareHandler.getMiddlewares().forEach((s)=>{let e=P(r,s.path);this.middlewareHandler.use(e,s.handler)})}),this}routeHandler(i){return this.handleRouteHandler(i),this}get(i,...n){return this.addRoute("GET",i,...n)}post(i,...n){return this.addRoute("POST",i,...n)}put(i,...n){return this.addRoute("PUT",i,...n)}patch(i,...n){return this.addRoute("PATCH",i,...n)}delete(i,...n){return this.addRoute("DELETE",i,...n)}head(i,...n){return this.addRoute("HEAD",i,...n)}options(i,...n){return this.addRoute("OPTIONS",i,...n)}async listen(i=3000,n="localhost",r,t){return O(this,i,n,r,t)}}export{A as Bunzai};export{A as a};
