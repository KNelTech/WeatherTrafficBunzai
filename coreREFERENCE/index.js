// @bun
function A(t,r,n,i,s){let e={port:t,hostname:r,reusePort:n,fetch:(o)=>s.handleRequest(o)};if(i)e.tls={cert:Bun.file(i.cert),key:Bun.file(i.key),ca:i.ca?i.ca.map((o)=>Bun.file(o)):void 0};return e}function D(t){return Number.isInteger(t)&&t>=1&&t<=65535}function U(t){return typeof t==="string"&&t.length>4}async function q(t,r=3000,n="localhost",i,s){if(typeof Bun.serve!=="function")throw new Error("Please install Bun to use Bunzai.");if(!D(r)||!U(n)){let e=`Invalid hostname: ${n} or port number: ${r}. Port must be an integer between 1 and 65535.`;throw new Error(e)}try{let e=A(r,n,i,s,t),o=Bun.serve(e);return{port:o.port,hostname:o.hostname}}catch(e){throw console.error("Failed to start server:",e),new Error("Failed to start server due to unexpected error.")}}var x=(t)=>{return"/"+t.split("/").filter((r)=>Boolean(r)).join("/")},f=(...t)=>{return t.map((r)=>x(r)).join("/").replace(/\/+$/,"")},g=(t)=>{if(typeof t!=="string")throw new Error("Invalid key: must be a string");let r=t.trim();if(!r)throw new Error("Invalid key: must be a non-empty string");if(r.includes("\0"))throw new Error("Invalid key: must not contain a null character (\\0)");if(r.length>100)throw new Error("Invalid key: must not be longer than 100 characters");return r};function C(t){return t==="/"?"/":t.replace(/\/+$/,"").replace(/^\/+/,"/")}function S(t,r){if(r instanceof Response)return r;if(typeof r==="string")return _(r)?t.html(r):t.text(r);if(typeof r==="object")return t.json(r);return t.serverError("Invalid handler result")}function _(t){return/<!DOCTYPE html>|<html>|<head>|<body>|<div>/.test(t.trim())}class T{children=new Map;route=null;isParam=!1;paramName="";isWildcard=!1}var B={};function L(t){let r=B[t];if(r)return r;let n=[],i=t.replace(/\/+$/,"").replace(/\/\*$/,"/(.*)").replace(/\/:(\w+)\?/g,"(?:/([^/]+))?").replace(/\/:(\w+)(\([^)]+\))?/g,(o,l,a)=>{return n.push(l),a?`/(${a.slice(1,-1)})`:"/([^/]+)"}),s=t.match(/\/:([\w?]+)/g)||[];if(n.push(...s.map((o)=>o.slice(2).replace("?",""))),t.endsWith("*"))n.push("wildcard");let e={pattern:i,keys:n};return B[t]=e,e}var I=(()=>{let t=new Map;return(r)=>{if(!t.has(r))t.set(r,L(r));return t.get(r)}})();class m{root=new T;regexRoutes=[];routeCache=new Map;regexRoutesIndex=new Map;createRoute(t,r,n,i,s){return{method:t,handler:n,originalPath:r,regex:void 0,keys:new Set,path:void 0,params:new Map,middleware:i,routerStrategy:s}}addRoute(t,r,n,i=[],s){let e=C(r);if(s==="regexp"||e.includes(":")||e.includes("*"))this.addRegexRoute(t,e,n,i,s);else this.addTrieRoute(t,e,n,i,s)}addRegexRoute(t,r,n,i,s){let{pattern:e,keys:o}=I(r),l={method:t,handler:n,originalPath:r,regex:new RegExp(`^${e}\$`),keys:new Set(o),path:new RegExp(`^${e}\$`),params:new Map,middleware:i,routerStrategy:s};this.regexRoutes.push(l);let a=r.split("/")[1]||"",c=a.startsWith(":")||a==="*"?"__DYNAMIC__":a;if(!this.regexRoutesIndex.has(c))this.regexRoutesIndex.set(c,[]);this.regexRoutesIndex.get(c).push(l)}addTrieRoute(t,r,n,i,s){let e=this.root,o=r.split("/").filter(Boolean);if(r==="/"){e.route=this.createRoute(t,r,n,i,s);return}for(let[l,a]of o.entries()){let c=l===o.length-1;if(a.startsWith(":"))e=e.children.get("*")??this.ensureChildNode(e,"*"),e.isParam=!0,e.paramName=a.slice(1);else e=this.ensureChildNode(e,a);if(c)e.route=this.createRoute(t,r,n,i,s)}}ensureChildNode(t,r){let n=t.children.get(r);if(!n)n=new T,t.children.set(r,n);return n}findRoute(t,r,n){let i=C(r),s=`${t}:${i}:${n}`;if(this.routeCache.has(s))return this.routeCache.get(s);let e;if(e=this.findTrieRoute(t,i,n),!e&&n==="regexp")e=this.findRegexRoute(t,i,n);if(e)this.routeCache.set(s,e);return e}findTrieRoute(t,r,n){if(n==="regexp")return;let i=r.split("/").filter(Boolean),s=new Map,e=this.root;if(r==="/"&&e.route?.method===t)return{route:e.route,params:s};for(let o of i){let l=e.children.get(o);if(l){e=l;continue}let a=e.children.get("*");if(a?.isParam)s.set(a.paramName,o),e=a;else return}if(e.route?.method===t&&e.route?.routerStrategy===n)return{route:e.route,params:s};return}findRegexRoute(t,r,n){if(n!=="regexp")return;let i=r.split("?")[0],s=i.split("/")[1]||"",e=[...this.regexRoutesIndex.get(s)||[],...this.regexRoutesIndex.get("__DYNAMIC__")||[]];if(e.length===0)return;let o,l=-1;for(let a of e){if(a.method!==t||a.routerStrategy!==n)continue;let c=a.regex?.exec(i);if(!c)continue;let $=new Map,w=1;for(let R of a.keys){if(c[w]!==void 0)$.set(R,c[w]);w++}let M=a.originalPath.split("/").filter((R)=>!R.startsWith(":")&&R!=="*").length;if(M>l)o={route:a,params:$},l=M}return o}async handleRequest(t,r,n,i){let s=this.findRoute(r,t,i);if(s){n.setParams(Object.fromEntries(s.params));for(let o of s.route.middleware)await o(n,()=>Promise.resolve());let e=await s.route.handler(n);return S(n,e)}return}getRoutes(){let t=[],r=(n,i="")=>{if(n.route)t.push(n.route);for(let[s,e]of n.children){let o=i+(s==="*"?"/:"+e.paramName:"/"+s);r(e,o)}};return r(this.root),[...t,...this.regexRoutes]}}class b{strategy;cache=new Map;constructor(){this.strategy=new m}addRoute(t,r,n,i=[],s="trie"){try{this.strategy.addRoute(t,r,n,i,s)}catch(e){throw console.error(`Failed to add route ${t} ${r}:`,e),e}return this}async handleRequest(t,r,n){let i=this.getCacheKey(r,t),s=this.getCachedRoute(i,n);if(s)return s;let e=this.findRoute(r,t);if(e)return this.cacheRoute(i,e),this.handleRouteResult(e,n);return}getRoutes(){return this.strategy.getRoutes()}getCacheKey(t,r){return`${t}:${r}`}getCachedRoute(t,r){let n=this.cache.get(t);if(n)return r.setParams(Object.fromEntries(n.params)),this.runMiddlewareAndHandler(n.route,r);return}findRoute(t,r){return this.strategy.findRoute(t,r,"trie")||this.strategy.findRoute(t,r,"regexp")}cacheRoute(t,r){this.cache.set(t,r)}async handleRouteResult(t,r){return r.setParams(Object.fromEntries(t.params)),this.runMiddlewareAndHandler(t.route,r)}async runMiddlewareAndHandler(t,r){for(let i of t.middleware)await i(r,()=>Promise.resolve());let n=await t.handler(r);return S(r,n)}}class v{request;_params;_pathname=null;constructor(t){this.request=t,this._params=new URL(t.url).searchParams}get method(){return this.request.method}get url(){return this.request.url}get headers(){return this.request.headers}getPathname(){if(this._pathname===null)this._pathname=new URL(this.request.url).pathname;return this._pathname}reqHasHeader(t){return this.request.headers.has(t)}reqHeader(t){return this.request.headers.get(t)}reqAllHeaders(){let t={};return this.request.headers.forEach((r,n)=>{t[n]=r}),t}getCookie(t){let r=this.reqHeader("cookie");if(!r)return null;let n=r.split(";");for(let i of n){let[s,...e]=i.trim().split("=");if(s===t)return decodeURIComponent(e.join("="))}return null}async reqJson(){let t=this.reqHeader("content-type");if(!t||!t.includes("application/json"))throw new Error("Content-Type is not application/json");let r=await this.request.text();return JSON.parse(r)}async reqText(){return this.request.text()}async reqBlob(){let t=this.reqHeader("content-type");if(!t)throw new Error("Content-Type is not set");let r=await this.request.blob();if(r.type!==t)throw new Error(`Content-Type does not match blob type, expected ${t} but got ${r.type}`);return r}async reqFormData(){return this.request.formData()}hasBody(){return["POST","PUT","PATCH","DELETE"].includes(this.method.toUpperCase())}isJson(){return this.reqHeader("content-type")?.includes("application/json")??!1}isHtml(){return this.reqHeader("content-type")?.includes("text/html")??!1}isFormData(){let t=this.reqHeader("content-type");return t?.includes("multipart/form-data")||t?.includes("application/x-www-form-urlencoded")||!1}param(t){return this._params.get(t)}query(){let t={};return this._params.forEach((r,n)=>{if(t[n])if(Array.isArray(t[n]))t[n].push(r);else t[n]=[t[n],r];else t[n]=r}),t}hasQueryParam(t){return this._params.has(t)}reqQueryParams(...t){let r={};return t.forEach((n)=>{r[n]=this._params.get(n)??null}),r}}var j=globalThis.Bun;var E=Symbol.for("bunzai.fragment");class u extends Error{r;constructor(t,r){super(t);this.component=r;this.name="JSXRenderError"}}class h{transpiler;componentCache=new Map;propsCache=new Map;renderCache=new Map;eventHandlers=new Map;childrenCache=new Map;static VOID_ELEMENTS=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]);static EMPTY_RESULT="";constructor(t){this.transpiler=new j.Transpiler({loader:"jsx",target:"browser",minifyWhitespace:!0,...t})}handleEvent(t,r,n){let i=`${n||""}_${t}_${j.randomUUIDv7()}`;return this.eventHandlers.set(i,r),`data-bunzai-event="${i}" data-event-type="${t}"`}escapeHtml(t){let r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,(n)=>r[n])}serializeProps(t){if(!t)return h.EMPTY_RESULT;let r=JSON.stringify(t),n=this.propsCache.get(r);if(n)return n;let i=Object.entries(t).filter(([s,e])=>e!=null).map(([s,e])=>{if(typeof e==="function"&&s.startsWith("on"))return this.handleEvent(s.slice(2).toLowerCase(),e);if(s==="className")s="class";if(s==="htmlFor")s="for";let o=typeof e==="string"?`"${this.escapeHtml(e)}"`:typeof e==="boolean"&&e?s:`"${this.escapeHtml(String(e))}"`;return` ${s}=${o}`}).join("");return this.propsCache.set(r,i),i}renderComponent(t,r){try{let n=JSON.stringify({component:t.name,props:r}),i=this.renderCache.get(n);if(i)return i;let s=t(r);return this.renderCache.set(n,s),s}catch(n){throw new u(`Error rendering component: ${n instanceof Error?n.message:String(n)}`,t.displayName||t.name)}}transpileJSX(t){try{return this.transpiler.transformSync(t)}catch(r){throw console.error("JSX transpilation failed:",r),r}}flattenChildren=(t)=>{let r=this.childrenCache.get(t);if(r)return r;let n=t.flat().filter(Boolean);return this.childrenCache.set(t,n),n};renderChildren(t){return t.flat().filter((r)=>r!=null).map((r)=>{if(typeof r==="string")return this.escapeHtml(r);if(typeof r==="number")return String(r);if(Array.isArray(r))return this.renderChildren(r);if(typeof r==="object"&&r!==null)return this.renderJSX(r);return""}).join("")}renderJSX(t){try{if(t.type===E)return this.renderChildren(t.children);if(typeof t.type==="string")return this.jsx(t.type,t.props,...t.children);if(typeof t.type==="function")return this.renderComponent(t.type,{...t.props,children:t.children});throw new u(`Unsupported element type: ${String(t.type)}`)}catch(r){if(r instanceof u)throw r;throw new u(`Render failed: ${String(r)}`)}}createComponent(t){let r=this.componentCache.get(t);if(r)return r;let n=(i)=>{try{return this.renderComponent(t,i)}catch(s){throw new u(`Component creation failed: ${String(s)}`,t.displayName||t.name)}};return n.displayName=t.displayName||t.name,this.componentCache.set(t,n),n}jsx=(t,r,...n)=>{try{let i=this.flattenChildren(n);if(t===E)return this.renderChildren(i);if(typeof t==="function")return this.renderComponent(t,{...r,children:i});if(typeof t==="object"&&t!==null)return this.renderJSX(t);if(typeof t==="string"){let e=h.VOID_ELEMENTS.has(t)?`<${t}${this.serializeProps(r)}/>`:`<${t}${this.serializeProps(r)}>${this.renderChildren(i)}</${t}>`;return this.transpileJSX(e)}throw new u(`Invalid JSX element type: ${String(t)}`)}catch(i){if(i instanceof u)throw i;throw new u(`JSX transformation failed: ${String(i)}`)}};clearCaches(){this.componentCache.clear(),this.propsCache.clear(),this.renderCache.clear(),this.eventHandlers.clear()}getEventHandler(t){return this.eventHandlers.get(t)}}class d{headers;_response=null;transpiler;constructor(){this.headers=new Headers,this.transpiler=new h}defaultOptions={status:200,headers:{}};mergeOptions(t){return{...this.defaultOptions,...t,headers:{...this.defaultOptions.headers,...t.headers}}}createResponse(t,r={}){let n=this.mergeOptions(r),i=new Headers(this.headers);for(let[s,e]of Object.entries(n.headers||{})){let o=s.toLowerCase();if(!this.headers.has(o))i.set(o,e)}return new Response(t,{...n,headers:i})}handleError(t,r){return console.error(r,t),this.serverError(r)}updateInternalResponse(){if(this._response)this._response=this.createResponse(this._response.body,{status:this._response.status,statusText:this._response.statusText})}serializeCookie(t,r,n){let i=`${t}=${encodeURIComponent(r)}`;if(n.maxAge!==void 0)i+=`; Max-Age=${n.maxAge}`;if(n.domain)i+=`; Domain=${n.domain}`;if(i+=`; Path=${n.path}`,n.secure)i+="; Secure";if(n.httpOnly)i+="; HttpOnly";if(n.sameSite)i+=`; SameSite=${n.sameSite}`;if(n.expires)i+=`; Expires=${n.expires.toUTCString()}`;return i}headersToObject(t){let r={};return t.forEach((n,i)=>{r[i]=n}),r}renderJSX(t){try{return this.transpiler.renderJSX(t)}catch(r){return console.error("JSX Render Error:",r),`<!-- Error rendering JSX: ${r instanceof u?r.message:String(r)} -->`}}createComponent(t){return this.transpiler.createComponent(t)}jsx(t,r,...n){try{let i=this.transpiler.jsx(t,r,...n);return this.createResponse(i,{headers:{"Content-Type":"text/html"}})}catch(i){return this.handleError(i,"Error generating JSX response")}}json(t,r={}){if(t===void 0)return this.badRequest("Invalid data provided");try{let n=JSON.stringify(t);return this.createResponse(n,{...r,headers:{"Content-Type":"application/json"}})}catch(n){return this.handleError(n,"Error processing JSON response")}}text(t,r={}){try{return this.createResponse(t,{...r,headers:{"Content-Type":"text/plain"}})}catch(n){return this.handleError(n,"Error processing text response")}}html(t,r={}){try{return this.createResponse(t,{...r,headers:{"Content-Type":"text/html"}})}catch(n){return this.handleError(n,"Error processing HTML response")}}redirect(t,r={}){return this.createResponse(null,{...r,status:302,headers:{Location:t}})}notFound(t="404 Not Found",r={}){return this.text(t,{...r,status:404})}badRequest(t="Bad Request",r={}){return this.text(t,{...r,status:400})}serverError(t="Internal Server Error",r={}){return console.error({type:"ServerError",message:t,timestamp:new Date().toISOString(),requestId:crypto.randomUUID()}),this.text(t,{...r,status:500})}created(t,r={}){let n=JSON.stringify(t);return this.json(n,{...r,status:201})}noContent(t={}){return this.createResponse(null,{...t,status:204})}file(t,r,n={}){let i={"Content-Disposition":`attachment; filename="${encodeURIComponent(r)}"`};if(!t)this.setHeader("Content-Type","application/octet-stream");return this.createResponse(t,{...n,headers:i})}formData(t,r={}){return this.createResponse(t,{...r,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}stream(t,r={}){let n=new Headers(r.headers||{});if(!n.has("Content-Type"))n.set("Content-Type","application/octet-stream");return this.createResponse(t,{...r,headers:{"Content-Type":"application/octet-stream"}})}setCookie(t,r,n={}){let i=Object.assign({path:"/",httpOnly:!0,secure:!0,sameSite:"Lax"},n),s=this.serializeCookie(t,r,i);try{this.appendHeader("Set-Cookie",s)}catch(e){console.error("Failed to set cookie:",e)}}delCookie(t,r={}){this.setCookie(t,"",{...r,maxAge:0})}appendHeader(t,r){this.headers.append(t,r),this.updateInternalResponse()}setHeader(t,r){this.headers.set(t,r),this.updateInternalResponse()}setHeaders(t){for(let[r,n]of Object.entries(t))this.headers.set(r,n);this.updateInternalResponse()}getHeader(t){return this.headers.get(t)}getAllHeaders(){return this.headersToObject(this.headers)}removeHeader(t){this.headers.delete(t),this.updateInternalResponse()}setResponse(t){this._response=t,this.headers=new Headers(t.headers)}getResponse(){return this._response}getStatus(){return this._response?this._response.status:0}updateResponse(t){if(t.status===0)throw new Error("Status code cannot be 0");let r=this.createResponse(t.body,{status:t.status,statusText:t.statusText,headers:this.headersToObject(t.headers)});this._response=r,this.headers=new Headers(t.headers)}}class p{req;res;params;locals;constructor(t){this.req=new v(t),this.res=new d,this.params={},this.locals=new Map}renderJSX(t){return this.res.renderJSX(t)}createComponent(t){return this.res.createComponent(t)}jsx(t,r,...n){return this.res.jsx(t,r,...n)}set(t,r){let n=g(t);this.locals.set(n,{type:typeof r,value:r})}get(t){let r=g(t),n=this.locals.get(r);if(n&&typeof n.value===n.type)return n.value;return}has(t){let r=g(t);return this.locals.has(r)}delete(t){let r=g(t);this.locals.delete(r)}getAll(){return new Map(this.locals)}getAllKeys(){return Array.from(this.locals.keys())}setParam(t,r){this.params[t]=r}setParams(t){this.params=t}getParam(t){return this.params[t]}getAllParams(){return this.params}getResponse(){return this.res.getResponse()}setResponse(t){return this.res.setResponse(t),this}updateResponse(t){this.res.updateResponse(t)}getPathname(){return this.req.getPathname()}getMethod(){return this.req.method}getUrl(){return this.req.url}getHeaders(){return this.req.headers}reqHasHeader(t){return this.req.reqHasHeader(t)}reqHeader(t){return this.req.reqHeader(t)}reqAllHeaders(){return this.req.reqAllHeaders()}reqJson(){return this.req.reqJson()}reqText(){return this.req.reqText()}reqBlob(){return this.req.reqBlob()}reqFormData(){return this.req.reqFormData()}hasBody(){return this.req.hasBody()}isJson(){return this.req.isJson()}isHtml(){return this.req.isHtml()}isFormData(){return this.req.isFormData()}param(t){return this.req.param(t)}query(){return this.req.query()}hasQueryParam(t){return this.req.hasQueryParam(t)}reqQueryParams(...t){return this.req.reqQueryParams(...t)}json(t,r){let n=this.res.json(t,r);return this.setResponse(n),n}text(t,r){let n=this.res.text(t,r);return this.setResponse(n),n}html(t,r){let n=this.res.html(t,r);return this.setResponse(n),n}redirect(t,r){let n=this.res.redirect(t,r);return this.setResponse(n),n}notFound(t="404 Not Found",r){let n=this.res.notFound(t,r);return this.setResponse(n),n}badRequest(t="Bad Request"){let r=this.res.badRequest(t);return this.setResponse(r),r}serverError(t="Internal Server Error"){let r=this.res.serverError(t);return this.setResponse(r),r}created(t,r){let n=this.res.created(t,r);return this.setResponse(n),n}file(t,r,n){let i=this.res.file(t,r,n);return this.setResponse(i),i}formData(t,r){let n=this.res.formData(t,r);return this.setResponse(n),n}stream(t,r){let n=this.res.stream(t,r);return this.setResponse(n),n}setCookie(t,r,n){this.res.setCookie(t,r,n)}getCookie(t){return this.req.getCookie(t)}delCookie(t,r){this.res.delCookie(t,r)}appendHeader(t,r){this.res.appendHeader(t,r)}setHeader(t,r){this.res.setHeader(t,r)}setHeaders(t){this.res.setHeaders(t)}getHeader(t){return this.res.getHeader(t)}getAllHeaders(){return this.res.getAllHeaders()}removeHeader(t){this.res.removeHeader(t)}noContent(t){let r=this.res.noContent(t);return this.setResponse(r),r}getStatus(){return this.res.getStatus()}}async function O(t,r,n,i){let s=new p(t);if(await n.runPreRoutingMiddlewares(s),!s.getResponse()){let o=await r.handleRequest(s.getPathname(),s.getMethod(),s);if(o instanceof Response)s.setResponse(o);else if(!s.getResponse())await W(s,i);if(!s.getResponse())s.setResponse(s.notFound())}await n.runPostRoutingMiddlewares(s);let e=s.getResponse();if(s.getMethod()==="HEAD")return new Response(null,{status:e.status,headers:e.headers});return e}async function W(t,r){for(let n of r){let i=await n.handle(t);if(i){t.setResponse(i);break}}}class H{preRoutingMiddlewares=new Map;postRoutingMiddlewares=new Map;async runPreRoutingMiddlewares(t){await this.runMiddlewares(t,this.preRoutingMiddlewares)}async runPostRoutingMiddlewares(t){await this.runMiddlewares(t,this.postRoutingMiddlewares)}use(t,...r){let n="/",i,s="pre";if(typeof t==="string")n=t,i=r.filter((l)=>typeof l!=="string");else i=[t];let e=r[r.length-1];if(e==="pre"||e==="post")s=e;let o=s==="pre"?this.preRoutingMiddlewares:this.postRoutingMiddlewares;return this.addMiddleware(o,n,...i)}addMiddleware(t,r,...n){if(n.length===0)throw console.error("No valid middleware provided"),new Error("No valid middleware provided");if(!t.has(r))t.set(r,[]);return t.get(r).push(...n),this}group(...t){return async(r,n)=>{let i=-1,s=async(e)=>{if(e<=i)throw new Error("next() called multiple times");i=e;let o=t[e];if(o)await o(r,()=>s(e+1));else await n()};await s(0)}}useWhen(t,...r){let n=async(i,s)=>{if(t(i))await this.group(...r)(i,s);else await s()};return this.use(n)}createNext(t,r){let n=new URL(t.getUrl()).pathname,i=Array.from(r.keys()).filter((l)=>n.startsWith(l)).sort((l,a)=>a.length-l.length),s=0,e=0,o=async()=>{while(s<i.length){let l=i[s],a=r.get(l);if(e<a.length){let c=a[e];e++,await c(t,o);return}s++,e=0}};return o}getMiddlewares(t="pre"){let r=t==="pre"?this.preRoutingMiddlewares:this.postRoutingMiddlewares,n=[];for(let[i,s]of r)for(let e of s)n.push({path:i,handler:e});return n}async runMiddlewares(t,r){if(await this.createNext(t,r)(),t.getResponse())return}}import{join as P,extname as V,normalize as G}from"path";var F={".html":"text/html",".htm":"text/html",".md":"text/markdown",".txt":"text/plain",".xml":"application/xml",".json":"application/json",".map":"application/json",".csv":"text/csv",".css":"text/css",".js":"application/javascript",".mjs":"application/javascript",".ts":"application/typescript",".wasm":"application/wasm",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".bmp":"image/bmp",".svg":"image/svg+xml",".ico":"image/x-icon",".webp":"image/webp",".avif":"image/avif",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".ogg":"audio/ogg",".mp4":"video/mp4",".m4v":"video/x-m4v",".webm":"video/webm",".woff":"font/woff",".woff2":"font/woff2",".ttf":"font/ttf",".otf":"font/otf",".zip":"application/zip",".tar":"application/x-tar",".gz":"application/gzip",".rar":"application/vnd.rar",".7z":"application/x-7z-compressed",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation"};class J{fullStaticPath;basePath;spa;index;cacheControl;responseUtils;constructor(t,r,n,i={}){this.basePath=r.startsWith("/")?r:`/${r}`,this.fullStaticPath=P(t,n),this.spa=i.spa||!1,this.index=i.index||"index.html",this.cacheControl=i.cacheControl||this.generateCacheControl(i),this.responseUtils=new d}generateCacheControl(t){let r=[`max-age=${t.maxAge||0}`];if(t.immutable)r.push("immutable");return r.join(", ")}createFileStream(t){return Bun.file(t).stream().pipeThrough(new TransformStream)}async getFilePath(t){let r=t.startsWith(this.basePath)?t.slice(this.basePath.length):t;r=r.replace(/^\/+/,"");let n=P(this.fullStaticPath,r);if(n=G(n),!n.startsWith(this.fullStaticPath))return null;let i=Bun.file(n);if(await i.exists())if((await i.text()).startsWith("directory;")){let e=P(n,this.index);if(await Bun.file(e).exists())return e}else return n;if(this.spa){let e=P(this.fullStaticPath,this.index);if(await Bun.file(e).exists()&&await Bun.file(n).exists())return e}return null}async handle(t){if(t.getMethod()!=="GET"&&t.getMethod()!=="HEAD")return;let r=new URL(t.getUrl()).pathname,n;if(n=r===this.basePath||r===`${this.basePath}/`?P(this.fullStaticPath,this.index):await this.getFilePath(r),!n){console.log(`File not found: ${r}`);return}let i=Bun.file(n),s=V(n).toLowerCase(),o={"Content-Type":F[s]||"application/octet-stream","Content-Length":i.size.toString(),"Cache-Control":this.cacheControl,ETag:`W/"${i.size.toString(16)}-${i.lastModified.toString(16)}"`};if(t.getHeader("if-none-match")===o.ETag)return this.responseUtils.noContent({status:304,headers:o});let l=this.createFileStream(n);return this.responseUtils.createResponse(l,{status:200,headers:o})}}class y{t;plugins=new Map;installedPlugins=new Set;namespaces=new Map;constructor(t){this.app=t}getInstalledPlugins(){return Array.from(this.installedPlugins,(t)=>this.plugins.get(t))}getPluginDependencyGraph(){return Object.fromEntries(Array.from(this.plugins,([t,r])=>[t,r.dependencies??[]]))}getPluginMetadata(t){return this.plugins.get(t)}isPluginInstalled(t){return this.installedPlugins.has(t)}isVersionCompatible(t,r){let n=t.split("."),i=r.split(".");return n.every((s,e)=>s===i[e]||i[e]==="*")}createPluginAPI(){return{addMiddleware:this.app.use.bind(this.app),extendContext:(t)=>{Object.assign(p.prototype,t)},registerNamespace:(t,r)=>{this.namespaces.set(t,r)},getInstalledPlugins:this.getInstalledPlugins.bind(this),getPluginDependencyGraph:this.getPluginDependencyGraph.bind(this),addGetRoute:(t,...r)=>this.app.get(t,...r),addPostRoute:(t,...r)=>this.app.post(t,...r),addDeleteRoute:(t,...r)=>this.app.delete(t,...r)}}async installPlugin(t,r,n=new Set){if(this.installedPlugins.has(t))return;if(n.has(t))throw new Error(`Circular dependency detected: ${Array.from(n).join(" -> ")} -> ${t}`);n.add(t);let i=this.plugins.get(t);if(!i)throw new Error(`Plugin "${t}" is not registered.`);if(i.dependencies)for(let e of i.dependencies){if(!this.plugins.has(e.name)){if(e.optional){console.warn(`Optional dependency "${e.name}" for plugin "${t}" is not registered.`);continue}throw new Error(`Dependency "${e.name}" for plugin "${t}" is not registered.`)}if(e.version){let o=this.plugins.get(e.name)?.version;if(o&&!this.isVersionCompatible(o,e.version))throw new Error(`Incompatible version of "${e.name}" for plugin "${t}". Required: ${e.version}, Installed: ${o}`)}await this.installPlugin(e.name,void 0,new Set(n))}let s=this.createPluginAPI();try{await i.install(this.app,s,r),this.installedPlugins.add(t)}catch(e){throw console.error(`Error installing plugin "${t}":`,e),e}finally{n.delete(t)}}async plugin(t,r){if(this.plugins.has(t.name)){console.warn(`Plugin "${t.name}" is already registered.`);return}this.plugins.set(t.name,t),await this.installPlugin(t.name,r)}usePlugin(t){let r=this.namespaces.get(t);if(!r)throw new Error(`Namespace "${t}" not found`);return r}async uninstallPlugin(t){let r=this.plugins.get(t);if(!r||!this.installedPlugins.has(t))throw new Error(`Plugin "${t}" is not installed.`);if(r.uninstall)await r.uninstall(this.app);this.installedPlugins.delete(t),this.namespaces.delete(t)}}class X{router;baseDir;staticHandlers=[];pluginManager;middlewareHandler=new H;constructor(){this.router=new b,this.baseDir=process.cwd(),this.pluginManager=new y(this),this.middlewareHandler=new H}addRoute(t,r,...n){let i=n.slice(0,-1),s=n[n.length-1],e=r.includes(":")?"regexp":"trie";return this.router.addRoute(t,r,s,i,e),this}handleRouteHandler(t){let r=Object.keys(t);for(let n of r){let i=t[n];if(Array.isArray(i)){let[s,...e]=i;this.addRoute(n,s,...e)}else if(typeof i==="string")this.addRoute(n,i,()=>new Response("Not Implemented",{status:501}))}}async handleRequest(t){return O(t,this.router,this.middlewareHandler,this.staticHandlers)}async plugin(t,r){return this.pluginManager.plugin(t,r),this}usePlugin(t){return this.pluginManager.usePlugin(t)}static(t,r,n={}){let i=new J(this.baseDir,t,r,n);return this.staticHandlers.push(i),this}use(t,...r){return this.middlewareHandler.use(t,...r),this}group(...t){return this.middlewareHandler.group(...t)}useWhen(t,...r){return this.middlewareHandler.useWhen(t,...r),this}route(t,...r){if(r.length===0)throw new Error("No sub app provided");let n=f(t);return r.forEach((i)=>{if(!(i instanceof X))throw new Error("Sub app is not an instance of Bunzai");i.router.getRoutes().forEach((s)=>{let e=f(n,s.originalPath);this.router.addRoute(s.method,e,s.handler,s.middleware||[])}),i.middlewareHandler.getMiddlewares().forEach((s)=>{let e=f(n,s.path);this.middlewareHandler.use(e,s.handler)})}),this}routeHandler(t){return this.handleRouteHandler(t),this}get(t,...r){return this.addRoute("GET",t,...r)}post(t,...r){return this.addRoute("POST",t,...r)}put(t,...r){return this.addRoute("PUT",t,...r)}patch(t,...r){return this.addRoute("PATCH",t,...r)}delete(t,...r){return this.addRoute("DELETE",t,...r)}head(t,...r){return this.addRoute("HEAD",t,...r)}options(t,...r){return this.addRoute("OPTIONS",t,...r)}async listen(t=3000,r="localhost",n,i){return q(this,t,r,n,i)}}export{X as Bunzai};export{X as a};
