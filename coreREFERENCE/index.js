// @bun
function K(e,r,t,n,i){let s={port:e,hostname:r,reusePort:t,fetch:(o)=>i.handleRequest(o)};if(n)s.tls={cert:Bun.file(n.cert),key:Bun.file(n.key),ca:n.ca?n.ca.map((o)=>Bun.file(o)):void 0};return s}function L(e){return Number.isInteger(e)&&e>=1&&e<=65535}function _(e){return typeof e==="string"&&e.length>4}async function x(e,r=3000,t="localhost",n,i){if(typeof Bun.serve!=="function")throw new Error("Please install Bun to use Bunzai.");if(!L(r)||!_(t)){let s=`Invalid hostname: ${t} or port number: ${r}. Port must be an integer between 1 and 65535.`;throw new Error(s)}try{let s=K(r,t,n,i,e),o=Bun.serve(s);return{port:o.port,hostname:o.hostname}}catch(s){throw console.error("Failed to start server:",s),new Error("Failed to start server due to unexpected error.")}}var O=(e)=>{return"/"+e.split("/").filter((r)=>Boolean(r)).join("/")},m=(...e)=>{return e.map((r)=>O(r)).join("/").replace(/\/+$/,"")},h=(e)=>{if(typeof e!=="string")throw new Error("Invalid key: must be a string");let r=e.trim();if(!r)throw new Error("Invalid key: must be a non-empty string");if(r.includes("\0"))throw new Error("Invalid key: must not contain a null character (\\0)");if(r.length>100)throw new Error("Invalid key: must not be longer than 100 characters");return r};function y(e){return e==="/"?"/":e.replace(/\/+$/,"").replace(/^\/+/,"/")}class q{request;_params;constructor(e){this.request=e,this._params=new URL(e.url).searchParams}get method(){return this.request.method}get url(){return this.request.url}get headers(){return this.request.headers}reqHasHeader(e){return this.request.headers.has(e)}reqHeader(e){return this.request.headers.get(e)}reqAllHeaders(){let e={};return this.request.headers.forEach((r,t)=>{e[t]=r}),e}getCookie(e){let r=this.reqHeader("cookie");if(!r)return null;let t=r.split(";");for(let n of t){let[i,...s]=n.trim().split("=");if(i===e)return decodeURIComponent(s.join("="))}return null}async reqJson(){let e=this.reqHeader("content-type");if(!e||!e.includes("application/json"))throw new Error("Content-Type is not application/json");let r=await this.request.text();return JSON.parse(r)}async reqText(){return this.request.text()}async reqBlob(){let e=this.reqHeader("content-type");if(!e)throw new Error("Content-Type is not set");let r=await this.request.blob();if(r.type!==e)throw new Error(`Content-Type does not match blob type, expected ${e} but got ${r.type}`);return r}async reqFormData(){return this.request.formData()}hasBody(){return["POST","PUT","PATCH","DELETE"].includes(this.method.toUpperCase())}isJson(){return this.reqHeader("content-type")?.includes("application/json")??!1}isFormData(){let e=this.reqHeader("content-type");return e?.includes("multipart/form-data")||e?.includes("application/x-www-form-urlencoded")||!1}param(e){return this._params.get(e)}query(){let e={};return this._params.forEach((r,t)=>{if(e[t])if(Array.isArray(e[t]))e[t].push(r);else e[t]=[e[t],r];else e[t]=r}),e}hasQueryParam(e){return this._params.has(e)}reqQueryParams(...e){let r={};return e.forEach((t)=>{r[t]=this._params.get(t)??null}),r}}class H{headers;_response=null;headerObjectCache=null;constructor(){this.headers=new Headers}headersToObject(e){let r={};return e.forEach((t,n)=>{r[n]=t}),r}json(e,r={}){if(e===void 0)return this.badRequest("Invalid data provided");try{let{status:t=200,headers:n={}}=r,i=JSON.stringify(e),s={...this.headersToObject(this.headers),"Content-Type":"application/json",...n};return this._response=new Response(i,{status:t,headers:s}),this._response}catch(t){return console.error("Error in json response:",t),this.serverError("Error processing JSON response")}}text(e,r={}){let{status:t=200,headers:n={}}=r,i={...this.headersToObject(this.headers),"Content-Type":"text/plain",...n};try{return this._response=new Response(e,{status:t,headers:i}),this._response}catch(s){return console.error("Error in text response:",s),this.serverError("Error processing text response")}}html(e,r={}){try{let{status:t=200,headers:n={}}=r,i={...this.headersToObject(this.headers),"Content-Type":"text/html",...n};return this._response=new Response(e,{status:t,headers:i}),this._response}catch(t){return console.error("Error in html response:",t),this.serverError("Error processing html response")}}redirect(e,r={}){let{status:t=302,headers:n={}}=r,i={...this.headersToObject(this.headers),Location:e,...n};return this._response=new Response(null,{status:t,headers:i}),this._response}notFound(e="404 Not Found",r={}){let{status:t=404,headers:n={}}=r,i=e,s={...this.headersToObject(this.headers),"Content-Type":"text/plain",...n};return this._response=new Response(i,{status:t,headers:s}),this._response}badRequest(e="Bad Request",r={}){return this.text(e,{...r,status:400})}serverError(e="Internal Server Error",r={}){return console.error({type:"ServerError",message:e,timestamp:new Date().toISOString(),requestId:crypto.randomUUID()}),this.text(e,{...r,status:500})}created(e,r={}){let{status:t=201,headers:n={}}=r,i=JSON.stringify(e),s={...this.headersToObject(this.headers),"Content-Type":"application/json",...n};return this._response=new Response(i,{status:t,headers:s}),this._response}noContent(e={}){let{status:r=204,headers:t={}}=e,n={...this.headersToObject(this.headers),"Content-Type":"text/plain",...t};try{return this._response=new Response(null,{status:r,headers:n}),this._response}catch(i){throw console.error("Failed to create response for no content:",i),new Error("Unable to create response no content")}}file(e,r,t={}){let{status:n=200,headers:i={}}=t,s={...this.headersToObject(this.headers),"Content-Disposition":`attachment; filename="${encodeURIComponent(r)}"`,...i};if(!e)s["Content-Type"]="application/octet-stream";try{return this._response=new Response(e,{status:n,headers:s}),this._response}catch(o){throw console.error("Failed to create response for file:",o),new Error("Unable to create response file")}}formData(e,r={}){let{status:t=200,headers:n={}}=r,i={"Content-Type":"application/x-www-form-urlencoded",...this.headersToObject(this.headers),...n};try{return this._response=new Response(e,{status:t,headers:i}),this._response}catch(s){throw console.error("Failed to create response for form data:",s),new Error("Unable to create response form data")}}stream(e,r={}){let{status:t=200,headers:n={}}=r,i={"Content-Type":"application/octet-stream",...this.headersToObject(this.headers),...n};try{return this._response=new Response(e,{status:t,headers:i}),this._response}catch(s){throw console.error("Failed to create response for stream:",s),new Error("Unable to create response stream")}}setCookie(e,r,t={}){let n=Object.assign({path:"/",httpOnly:!0,secure:!0,sameSite:"Lax"},t),i=this.serializeCookie(e,r,n);try{this.appendHeader("Set-Cookie",i)}catch(s){console.error("Failed to set cookie:",s)}}delCookie(e,r={}){this.setCookie(e,"",{...r,maxAge:0})}updateResponseHeaders(){if(this._response)this._response=new Response(this._response.body,{status:this._response.status,statusText:this._response.statusText,headers:new Headers(this.headers)})}appendHeader(e,r){this.headers.append(e,r),this.updateResponseHeaders()}setHeader(e,r){this.headers.set(e,r),this.updateResponseHeaders()}getHeader(e){return this.headers.get(e)??this._response?.headers.get(e)??null}getAllHeaders(){if(!this.headerObjectCache)this.headerObjectCache={},this.headers.forEach((e,r)=>{this.headerObjectCache[r]=e});return{...this.headerObjectCache}}removeHeader(e){if(this.headers.delete(e),this._response){let r=new Headers(this._response.headers);r.delete(e),this._response=new Response(this._response.body,{status:this._response.status,statusText:this._response.statusText,headers:r})}}setResponse(e){this._response=e,e.headers.forEach((r,t)=>{this.headers.set(t,r)})}getResponse(){return this._response}updateResponse(e){if(this._response)this._response=new Response(this._response.body,{status:e.status,statusText:e.statusText,headers:this.headers}),e.headers.forEach((r,t)=>{this.headers.set(t,r)});else this.setResponse(e)}serializeCookie(e,r,t){let n=`${e}=${encodeURIComponent(r)}`;if(t.maxAge!==void 0)n+=`; Max-Age=${t.maxAge}`;if(t.domain)n+=`; Domain=${t.domain}`;if(n+=`; Path=${t.path}`,t.secure)n+="; Secure";if(t.httpOnly)n+="; HttpOnly";if(t.sameSite)n+=`; SameSite=${t.sameSite}`;if(t.expires)n+=`; Expires=${t.expires.toUTCString()}`;return n}}var $=globalThis.Bun;var T=Symbol.for("bunzai.fragment");class u extends Error{r;constructor(e,r){super(e);this.component=r;this.name="JSXRenderError"}}class w{transpiler;componentCache=new Map;propsCache=new Map;renderCache=new Map;eventHandlers=new Map;childrenCache=new Map;static VOID_ELEMENTS=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]);static EMPTY_RESULT="";constructor(e){this.transpiler=new $.Transpiler({loader:"jsx",target:"browser",minifyWhitespace:!0,...e})}handleEvent(e,r,t){let n=`${t||""}_${e}_${$.randomUUIDv7()}`;return this.eventHandlers.set(n,r),`data-bunzai-event="${n}" data-event-type="${e}"`}escapeHtml(e){let r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(t)=>r[t])}serializeProps(e){if(!e)return w.EMPTY_RESULT;let r=JSON.stringify(e),t=this.propsCache.get(r);if(t)return t;let n=Object.entries(e).filter(([i,s])=>s!=null).map(([i,s])=>{if(typeof s==="function"&&i.startsWith("on"))return this.handleEvent(i.slice(2).toLowerCase(),s);if(i==="className")i="class";if(i==="htmlFor")i="for";let o=typeof s==="string"?`"${this.escapeHtml(s)}"`:typeof s==="boolean"&&s?i:`"${this.escapeHtml(String(s))}"`;return` ${i}=${o}`}).join("");return this.propsCache.set(r,n),n}renderComponent(e,r){try{let t=JSON.stringify({component:e.name,props:r}),n=this.renderCache.get(t);if(n)return n;let i=e(r);return this.renderCache.set(t,i),i}catch(t){throw new u(`Error rendering component: ${t instanceof Error?t.message:String(t)}`,e.displayName||e.name)}}transpileJSX(e){try{return this.transpiler.transformSync(e)}catch(r){throw console.error("JSX transpilation failed:",r),r}}flattenChildren=(e)=>{let r=this.childrenCache.get(e);if(r)return r;let t=e.flat().filter(Boolean);return this.childrenCache.set(e,t),t};renderChildren(e){return e.flat().filter((r)=>r!=null).map((r)=>{if(typeof r==="string")return this.escapeHtml(r);if(typeof r==="number")return String(r);if(Array.isArray(r))return this.renderChildren(r);if(typeof r==="object"&&r!==null)return this.renderJSX(r);return""}).join("")}renderJSX(e){try{if(e.type===T)return this.renderChildren(e.children);if(typeof e.type==="string")return this.jsx(e.type,e.props,...e.children);if(typeof e.type==="function")return this.renderComponent(e.type,{...e.props,children:e.children});throw new u(`Unsupported element type: ${String(e.type)}`)}catch(r){if(r instanceof u)throw r;throw new u(`Render failed: ${String(r)}`)}}createComponent(e){let r=this.componentCache.get(e);if(r)return r;let t=(n)=>{try{return this.renderComponent(e,n)}catch(i){throw new u(`Component creation failed: ${String(i)}`,e.displayName||e.name)}};return t.displayName=e.displayName||e.name,this.componentCache.set(e,t),t}jsx=(e,r,...t)=>{try{let n=this.flattenChildren(t);if(e===T)return this.renderChildren(n);if(typeof e==="function")return this.renderComponent(e,{...r,children:n});if(typeof e==="object"&&e!==null)return this.renderJSX(e);if(typeof e==="string"){let s=w.VOID_ELEMENTS.has(e)?`<${e}${this.serializeProps(r)}/>`:`<${e}${this.serializeProps(r)}>${this.renderChildren(n)}</${e}>`;return this.transpileJSX(s)}throw new u(`Invalid JSX element type: ${String(e)}`)}catch(n){if(n instanceof u)throw n;throw new u(`JSX transformation failed: ${String(n)}`)}};clearCaches(){this.componentCache.clear(),this.propsCache.clear(),this.renderCache.clear(),this.eventHandlers.clear()}getEventHandler(e){return this.eventHandlers.get(e)}}class R{req;res;params;locals;transpiler;constructor(e){this.req=new q(e),this.res=new H,this.params={},this.locals=new Map,this.transpiler=new w}renderJSX(e){try{return this.transpiler.renderJSX(e)}catch(r){return console.error("JSX Render Error:",r),`<!-- Error rendering JSX: ${r instanceof u?r.message:String(r)} -->`}}createComponent(e){return this.transpiler.createComponent(e)}jsx(e,r,...t){try{let n=this.transpiler.jsx(e,r,...t);return new Response(n,{headers:{"Content-Type":"text/html","X-Content-Type-Options":"nosniff"}})}catch(n){return console.error("JSX Response Error:",n),new Response(`Error generating response: ${n instanceof u?n.message:String(n)}`,{status:500})}}set(e,r){let t=h(e);this.locals.set(t,{type:typeof r,value:r})}get(e){let r=h(e),t=this.locals.get(r);if(t&&typeof t.value===t.type)return t.value;return}has(e){let r=h(e);return this.locals.has(r)}delete(e){let r=h(e);this.locals.delete(r)}getAll(){return new Map(this.locals)}getAllKeys(){return Array.from(this.locals.keys())}setParam(e,r){this.params[e]=r}setParams(e){this.params=e}getParam(e){return this.params[e]}getAllParams(){return this.params}getResponse(){return this.res.getResponse()}setResponse(e){return this.res.setResponse(e),this}updateResponse(e){this.res.updateResponse(e)}getMethod(){return this.req.method}getUrl(){return this.req.url}getHeaders(){return this.req.headers}reqHasHeader(e){return this.req.reqHasHeader(e)}reqHeader(e){return this.req.reqHeader(e)}reqAllHeaders(){return this.req.reqAllHeaders()}reqJson(){return this.req.reqJson()}reqText(){return this.req.reqText()}reqBlob(){return this.req.reqBlob()}reqFormData(){return this.req.reqFormData()}hasBody(){return this.req.hasBody()}isJson(){return this.req.isJson()}isFormData(){return this.req.isFormData()}param(e){return this.req.param(e)}query(){return this.req.query()}hasQueryParam(e){return this.req.hasQueryParam(e)}reqQueryParams(...e){return this.req.reqQueryParams(...e)}json(e,r){let t=this.res.json(e,r);return this.setResponse(t),t}text(e,r){let t=this.res.text(e,r);return this.setResponse(t),t}html(e,r){let t=this.res.html(e,r);return this.setResponse(t),t}redirect(e,r){let t=this.res.redirect(e,r);return this.setResponse(t),t}notFound(e="404 Not Found",r){let t=this.res.notFound(e,r);return this.setResponse(t),t}badRequest(e="Bad Request"){let r=this.res.badRequest(e);return this.setResponse(r),r}serverError(e="Internal Server Error"){let r=this.res.serverError(e);return this.setResponse(r),r}created(e,r){let t=this.res.created(e,r);return this.setResponse(t),t}file(e,r,t){let n=this.res.file(e,r,t);return this.setResponse(n),n}formData(e,r){let t=this.res.formData(e,r);return this.setResponse(t),t}stream(e,r){let t=this.res.stream(e,r);return this.setResponse(t),t}setCookie(e,r,t){this.res.setCookie(e,r,t)}getCookie(e){return this.req.getCookie(e)}delCookie(e,r){this.res.delCookie(e,r)}appendHeader(e,r){this.res.appendHeader(e,r)}setHeader(e,r){this.res.setHeader(e,r)}getHeader(e){return this.res.getHeader(e)}getAllHeaders(){return this.res.getAllHeaders()}removeHeader(e){this.res.removeHeader(e)}noContent(e){let r=this.res.noContent(e);return this.setResponse(r),r}}class M{children=new Map;route=null;isParam=!1;paramName="";isWildcard=!1}var B={};function V(e){let r=B[e];if(r)return r;let t=[],n=e.replace(/\/+$/,"").replace(/\/\*$/,"/(.*)").replace(/\/:(\w+)\?/g,"(?:/([^/]+))?").replace(/\/:(\w+)(\([^)]+\))?/g,(o,l,a)=>{return t.push(l),a?`/(${a.slice(1,-1)})`:"/([^/]+)"}),i=e.match(/\/:([\w?]+)/g)||[];if(t.push(...i.map((o)=>o.slice(2).replace("?",""))),e.endsWith("*"))t.push("wildcard");let s={pattern:n,keys:t};return B[e]=s,s}var W=(()=>{let e=new Map;return(r)=>{if(!e.has(r))e.set(r,V(r));return e.get(r)}})();class X{root=new M;regexRoutes=[];routeCache=new Map;regexRoutesIndex=new Map;createRoute(e,r,t,n,i){return{method:e,handler:t,originalPath:r,regex:void 0,keys:new Set,path:void 0,params:new Map,middleware:n,routerStrategy:i}}addRoute(e,r,t,n=[],i){let s=y(r);if(i==="regexp"||s.includes(":")||s.includes("*"))this.addRegexRoute(e,s,t,n,i);else this.addTrieRoute(e,s,t,n,i)}addRegexRoute(e,r,t,n,i){let{pattern:s,keys:o}=W(r),l={method:e,handler:t,originalPath:r,regex:new RegExp(`^${s}\$`),keys:new Set(o),path:new RegExp(`^${s}\$`),params:new Map,middleware:n,routerStrategy:i};this.regexRoutes.push(l);let a=r.split("/")[1]||"",c=a.startsWith(":")||a==="*"?"__DYNAMIC__":a;if(!this.regexRoutesIndex.has(c))this.regexRoutesIndex.set(c,[]);this.regexRoutesIndex.get(c).push(l)}addTrieRoute(e,r,t,n,i){let s=this.root,o=r.split("/").filter(Boolean);if(r==="/"){s.route=this.createRoute(e,r,t,n,i);return}for(let[l,a]of o.entries()){let c=l===o.length-1;if(a.startsWith(":"))s=s.children.get("*")??this.ensureChildNode(s,"*"),s.isParam=!0,s.paramName=a.slice(1);else s=this.ensureChildNode(s,a);if(c)s.route=this.createRoute(e,r,t,n,i)}}ensureChildNode(e,r){let t=e.children.get(r);if(!t)t=new M,e.children.set(r,t);return t}findRoute(e,r,t){let n=y(r),i=`${e}:${n}:${t}`;if(this.routeCache.has(i))return this.routeCache.get(i);let s;if(s=this.findTrieRoute(e,n,t),!s&&t==="regexp")s=this.findRegexRoute(e,n,t);if(s)this.routeCache.set(i,s);return s}findTrieRoute(e,r,t){if(t==="regexp")return;let n=r.split("/").filter(Boolean),i=new Map,s=this.root;if(r==="/"&&s.route?.method===e)return{route:s.route,params:i};for(let o of n){let l=s.children.get(o);if(l){s=l;continue}let a=s.children.get("*");if(a?.isParam)i.set(a.paramName,o),s=a;else return}if(s.route?.method===e&&s.route?.routerStrategy===t)return{route:s.route,params:i};return}findRegexRoute(e,r,t){if(t!=="regexp")return;let n=r.split("?")[0],i=n.split("/")[1]||"",s=[...this.regexRoutesIndex.get(i)||[],...this.regexRoutesIndex.get("__DYNAMIC__")||[]];if(s.length===0)return;let o,l=-1;for(let a of s){if(a.method!==e||a.routerStrategy!==t)continue;let c=a.regex?.exec(n);if(!c)continue;let C=new Map,f=1;for(let g of a.keys){if(c[f]!==void 0)C.set(g,c[f]);f++}let d=a.originalPath.split("/").filter((g)=>!g.startsWith(":")&&g!=="*").length;if(d>l)o={route:a,params:C},l=d}return o}async handleRequest(e,r,t,n){let i=this.findRoute(r,e,n);if(i){t.setParams(Object.fromEntries(i.params));for(let s of i.route.middleware)await s(t,()=>Promise.resolve());return i.route.handler(t)}return}getRoutes(){let e=[],r=(t,n="")=>{if(t.route)e.push(t.route);for(let[i,s]of t.children){let o=n+(i==="*"?"/:"+s.paramName:"/"+i);r(s,o)}};return r(this.root),[...e,...this.regexRoutes]}}class E{strategy;cache=new Map;constructor(){this.strategy=new X}addRoute(e,r,t,n=[],i="trie"){try{this.strategy.addRoute(e,r,t,n,i)}catch(s){throw console.error(`Failed to add route ${e} ${r}:`,s),s}return this}async handleRequest(e,r,t){let n=`${r}:${e}`,i=this.cache.get(n);if(i){t.setParams(Object.fromEntries(i.params));for(let o of i.route.middleware)await o(t,()=>Promise.resolve());return i.route.handler(t)}let s=this.strategy.findRoute(r,e,"trie")||this.strategy.findRoute(r,e,"regexp");if(s){this.cache.set(n,s),t.setParams(Object.fromEntries(s.params));for(let o of s.route.middleware)await o(t,()=>Promise.resolve());return s.route.handler(t)}return}getRoutes(){return this.strategy.getRoutes()}}async function A(e,r,t){let n=new R(e);try{if(await t.runMiddlewares(n),!n.getResponse()){let s=new URL(e.url),o=await r.handleRequest(s.pathname,e.method,n);if(o instanceof Response)n.setResponse(o);else if(o===void 0)n.setResponse(n.notFound())}let i=n.getResponse();if(n.getMethod()==="HEAD")return new Response(null,{status:i.status,headers:i.headers});return i}catch(i){return console.error("Unhandled error:",i),n.serverError()}}class S{middlewares=new Map;use(e,...r){if(typeof e!=="string"&&!Array.isArray(r))throw new Error("No valid middleware provided");let t=typeof e==="string"?e:"/",n=typeof e==="string"?r:[e,...r];if(n.length===0)throw new Error("No valid middleware provided");if(!this.middlewares.has(t))this.middlewares.set(t,[]);return this.middlewares.get(t).push(...n),this}group(...e){return async(r,t)=>{let n=-1,i=async(s)=>{if(s<=n)throw new Error("next() called multiple times");n=s;let o=e[s];if(o)await o(r,()=>i(s+1));else await t()};await i(0)}}useWhen(e,...r){let t=async(n,i)=>{if(e(n))await this.group(...r)(n,i);else await i()};return this.use(t)}createNext(e){let r=new URL(e.getUrl()).pathname,t=Array.from(this.middlewares.keys()).filter((o)=>r.startsWith(o)).sort((o,l)=>l.length-o.length),n=0,i=0,s=async()=>{while(n<t.length){let o=t[n],l=this.middlewares.get(o);if(i<l.length){let a=l[i];i++,await a(e,s);return}n++,i=0}};return s}getMiddlewares(){let e=[];for(let[r,t]of this.middlewares)for(let n of t)e.push({path:r,handler:n});return e}async runMiddlewares(e){await this.createNext(e)()}}var j={".html":"text/html",".htm":"text/html",".md":"text/markdown",".txt":"text/plain",".xml":"application/xml",".json":"application/json",".map":"application/json",".csv":"text/csv",".css":"text/css",".js":"application/javascript",".mjs":"application/javascript",".ts":"application/typescript",".wasm":"application/wasm",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".bmp":"image/bmp",".svg":"image/svg+xml",".ico":"image/x-icon",".webp":"image/webp",".avif":"image/avif",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".ogg":"audio/ogg",".mp4":"video/mp4",".m4v":"video/x-m4v",".webm":"video/webm",".woff":"font/woff",".woff2":"font/woff2",".ttf":"font/ttf",".otf":"font/otf",".zip":"application/zip",".tar":"application/x-tar",".gz":"application/gzip",".rar":"application/vnd.rar",".7z":"application/x-7z-compressed",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation"};import{join as P,extname as Q}from"path";function F(e,r,t,n={}){let{spa:i=!1,index:s="index.html",maxAge:o=0,immutable:l=!1}=n,a=P(e,t),c=()=>{let d=[`max-age=${o}`];if(l)d.push("immutable");return d.join(", ")},C=(d)=>{return Bun.file(d).stream().pipeThrough(new TransformStream)},f=async(d)=>{if(d.getMethod()!=="GET"&&d.getMethod()!=="HEAD")return d.notFound();let g=new URL(d.getUrl()),p=P(a,g.pathname.substring(r.length));if(p.endsWith("/")||!await Bun.file(p).exists()){if(p=P(p,s),!await Bun.file(p).exists())if(i)p=P(a,s);else return d.notFound()}let v=Bun.file(p),U=Q(p).toLowerCase(),I=j[U]||"application/octet-stream",J=new Headers({"Content-Type":I,"Content-Length":v.size.toString(),"Cache-Control":c(),ETag:`W/"${v.size.toString(16)}-${v.lastModified.toString(16)}"`});if(d.getHeader("if-none-match")===J.get("ETag"))return new Response(null,{status:304,headers:J});let D=C(p);return new Response(D,{status:200,headers:J})};return async(d,g)=>{if(d.getMethod()==="GET"||d.getMethod()==="HEAD"){let p=await f(d);if(p.status!==404){d.setResponse(p);return}}await g()}}class b{router;middlewareHandler=new S;baseDir;plugins=new Map;installedPlugins=new Set;namespaces=new Map;constructor(){this.router=new E,this.middlewareHandler=new S,this.baseDir=process.cwd()}getInstalledPlugins(){return Array.from(this.installedPlugins).map((e)=>this.plugins.get(e))}getPluginDependencyGraph(){let e={};for(let[r,t]of this.plugins)e[r]=t.dependencies||[];return e}addRoute(e,r,...t){let n=t.slice(0,-1),i=t[t.length-1],s=r.includes(":")?"regexp":"trie";return this.router.addRoute(e,r,i,n,s),this}handleRouteHandler(e){let r=Object.keys(e);for(let t of r){let n=e[t];if(Array.isArray(n)){let[i,...s]=n;this.addRoute(t,i,...s)}else if(typeof n==="string")this.addRoute(t,n,()=>new Response("Not Implemented",{status:501}))}}createPluginAPI(){return{addMiddleware:(e,...r)=>{this.middlewareHandler.use(e,...r)},addRoute:(e,r,...t)=>{this.addRoute(e,r,...t)},extendContext:(e)=>{Object.assign(R.prototype,e)},registerNamespace:(e,r)=>{this.namespaces.set(e,r)}}}installPlugin(e,r){if(this.installedPlugins.has(e))return;let t=this.plugins.get(e);if(!t)throw new Error(`Plugin "${e}" is not registered.`);if(t.dependencies)for(let s of t.dependencies){if(!this.plugins.has(s))throw new Error(`Dependency "${s}" for plugin "${e}" is not registered.`);this.installPlugin(s)}let n=this.createPluginAPI(),i=t.install(this,n,r);if(i instanceof Promise)i.catch((s)=>{console.error(`Error installing plugin "${e}":`,s)});this.installedPlugins.add(e)}async handleRequest(e){return A(e,this.router,this.middlewareHandler)}static(e,r,t={}){let n=F(this.baseDir,e,r,t);return this.middlewareHandler.use(e,n),this}use(e,...r){return this.middlewareHandler.use(e,...r),this}plugin(e,r){if(this.plugins.has(e.name))return console.warn(`Plugin "${e.name}" is already registered.`),this;return this.plugins.set(e.name,e),this.installPlugin(e.name,r),this}usePlugin(e){let r=this.namespaces.get(e);if(!r)throw new Error(`Namespace "${e}" not found`);return r}group(...e){return this.middlewareHandler.group(...e)}useWhen(e,...r){return this.middlewareHandler.useWhen(e,...r),this}route(e,...r){if(r.length===0)throw new Error("No sub app provided");let t=m(e);return r.forEach((n)=>{if(!(n instanceof b))throw new Error("Sub app is not an instance of Bunzai");n.router.getRoutes().forEach((i)=>{let s=m(t,i.originalPath);this.router.addRoute(i.method,s,i.handler,i.middleware||[])}),n.middlewareHandler.getMiddlewares().forEach((i)=>{let s=m(t,i.path);this.middlewareHandler.use(s,i.handler)})}),this}routeHandler(e){return this.handleRouteHandler(e),this}get(e,...r){return this.addRoute("GET",e,...r)}post(e,...r){return this.addRoute("POST",e,...r)}put(e,...r){return this.addRoute("PUT",e,...r)}patch(e,...r){return this.addRoute("PATCH",e,...r)}delete(e,...r){return this.addRoute("DELETE",e,...r)}head(e,...r){return this.addRoute("HEAD",e,...r)}options(e,...r){return this.addRoute("OPTIONS",e,...r)}async listen(e=3000,r="localhost",t,n){return x(this,e,r,t,n)}}export{b as Bunzai};export{b as a};
