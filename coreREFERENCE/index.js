// @bun
function K(e,t,r,s,n){let i={port:e,hostname:t,reusePort:r,fetch:(o)=>n.handleRequest(o)};if(s)i.tls={cert:Bun.file(s.cert),key:Bun.file(s.key),ca:s.ca?s.ca.map((o)=>Bun.file(o)):void 0};return i}function $(e){return Number.isInteger(e)&&e>=1&&e<=65535}function D(e){return typeof e==="string"&&e.length>4}async function v(e,t=3000,r="localhost",s,n){if(typeof Bun.serve!=="function")throw new Error("Please install Bun to use Bunzai.");if(!$(t)||!D(r)){let i=`Invalid hostname: ${r} or port number: ${t}. Port must be an integer between 1 and 65535.`;throw new Error(i)}try{let i=K(t,r,s,n,e),o=Bun.serve(i);return{port:o.port,hostname:o.hostname}}catch(i){throw console.error("Failed to start server:",i),new Error("Failed to start server due to unexpected error.")}}var F=(e)=>{return"/"+e.split("/").filter((t)=>Boolean(t)).join("/")},c=(...e)=>{return e.map((t)=>F(t)).join("/").replace(/\/+$/,"")},h=(e)=>{if(typeof e!=="string"||!e.trim())return;if(e.includes("\0")||e.length>100)throw new Error(["Invalid key:","  - must be a non-empty string","  - must not contain a null character (\\0)","  - must not be longer than 100 characters"].join("\n"));return e};function P(e){return/[*()?\[\]]/.test(e)}function b(e){return e==="/"?"/":e.replace(/\/+$/,"").replace(/^\/+/,"/")}function J(e){let t=[];return{pattern:e.replace(/\/:(\w+)/g,(s,n)=>{return t.push(n),"/([^/]+)"}).replace(/\*/g,".*"),keys:t}}class x{children=new Map;route=null;isParam=!1;paramName="";isWildcard=!1}class g{root=new x;regexRoutes=[];createRoute(e,t,r,s,n){return{method:e,handler:r,originalPath:t,regex:void 0,keys:[],path:void 0,params:[],middleware:s,routerStrategy:n}}ensureChildNode(e,t){if(!e.children.has(t))e.children.set(t,new x);return e.children.get(t)}addRoute(e,t,r,s=[],n){let i=b(t);if(n==="regexp"||P(i))this.addRegexRoute(e,i,r,s,n);else this.addTrieRoute(e,i,r,s,n)}addRegexRoute(e,t,r,s,n){let{pattern:i,keys:o}=J(t),d={method:e,handler:r,originalPath:t,regex:new RegExp(`^${i}\$`),keys:o,path:new RegExp(`^${i}\$`),params:[],middleware:s,routerStrategy:n};this.regexRoutes.push(d)}addTrieRoute(e,t,r,s,n){let i=this.root,o=t.split("/").filter(Boolean);if(t==="/"){i.route=this.createRoute(e,t,r,s,n);return}for(let d=0;d<o.length;d++){let u=o[d],f=d===o.length-1;if(u.startsWith(":"))i=this.ensureChildNode(i,"*"),i.isParam=!0,i.paramName=u.slice(1);else if(u==="*"){i=this.ensureChildNode(i,"**"),i.isWildcard=!0;break}else i=this.ensureChildNode(i,u);if(f)i.route=this.createRoute(e,t,r,s,n)}}findRoute(e,t,r){let s=r==="trie"?this.findTrieRoute(e,t,r):this.findRegexRoute(e,t,r);if(!s)s=r==="trie"?this.findRegexRoute(e,t,"regexp"):this.findTrieRoute(e,t,"trie");return s}findTrieRoute(e,t,r){let s=this.root,n=t.split("/").filter(Boolean),i={};if(t==="/"&&s.route&&s.route.method===e&&s.route.routerStrategy===r)return{route:s.route,params:i};for(let o of n)if(s.children.has(o))s=s.children.get(o);else if(s.children.has("*"))s=s.children.get("*"),i[s.paramName]=o;else if(s.children.has("**")){s=s.children.get("**"),i.wildcard=n.slice(n.indexOf(o)).join("/");break}else return;if(s.route&&s.route.method===e&&s.route.routerStrategy===r)return{route:s.route,params:i};return}findRegexRoute(e,t,r){for(let s of this.regexRoutes)if(s.method===e&&s.routerStrategy===r){let n=s.regex?.exec(t);if(n){let i={};return s.keys.forEach((o,d)=>{i[o]=n[d+1]}),{route:s,params:i}}}return}async handleRequest(e,t,r,s){let n=this.findRoute(t,e,s);if(n){r.setParams(n.params);for(let i of n.route.middleware)await i(r,()=>Promise.resolve());return n.route.handler(r)}return}getRoutes(){return[...this.getAllTrieRoutes(this.root),...this.regexRoutes]}getAllTrieRoutes(e,t=""){let r=[];if(e.route)r.push(e.route);for(let[s,n]of e.children){let i=t+(s==="*"?"/:"+n.paramName:"/"+s);r=r.concat(this.getAllTrieRoutes(n,i))}return r}}class M{strategy;cache=new Map;constructor(){this.strategy=new g}addRoute(e,t,r,s=[],n="trie"){try{this.strategy.addRoute(e,t,r,s,n)}catch(i){throw console.error(`Failed to add route ${e} ${t}:`,i),i}return this}async handleRequest(e,t,r){let s=`${t}:${e}`,n=this.cache.get(s);if(!n){if(n=this.strategy.findRoute(t,e,"trie")||this.strategy.findRoute(t,e,"regexp"),n)this.cache.set(s,n)}if(n){r.setParams(n.params);for(let o of n.route.middleware)await o(r,()=>Promise.resolve());return await n.route.handler(r)}return}getRoutes(){return this.strategy.getRoutes()}}class S{request;_params;constructor(e){this.request=e,this._params=new URL(e.url).searchParams}get method(){return this.request.method}get url(){return this.request.url}get headers(){return this.request.headers}reqHasHeader(e){return this.request.headers.has(e)}reqHeader(e){return this.request.headers.get(e)}reqAllHeaders(){let e={};return this.request.headers.forEach((t,r)=>{e[r]=t}),e}getCookie(e){let t=this.reqHeader("cookie");if(!t)return null;let r=t.split(";");for(let s of r){let[n,...i]=s.trim().split("=");if(n===e)return decodeURIComponent(i.join("="))}return null}async reqJson(){let e=this.reqHeader("content-type");if(!e||!e.includes("application/json"))throw new Error("Content-Type is not application/json");let t=await this.request.text();return JSON.parse(t)}async reqText(){return this.request.text()}async reqBlob(){let e=this.reqHeader("content-type");if(!e)throw new Error("Content-Type is not set");let t=await this.request.blob();if(t.type!==e)throw new Error(`Content-Type does not match blob type, expected ${e} but got ${t.type}`);return t}async reqFormData(){return this.request.formData()}hasBody(){return["POST","PUT","PATCH","DELETE"].includes(this.method.toUpperCase())}isJson(){return this.reqHeader("content-type")?.includes("application/json")??!1}isFormData(){let e=this.reqHeader("content-type");return e?.includes("multipart/form-data")||e?.includes("application/x-www-form-urlencoded")||!1}param(e){return this._params.get(e)}query(){let e={};return this._params.forEach((t,r)=>{if(e[r])if(Array.isArray(e[r]))e[r].push(t);else e[r]=[e[r],t];else e[r]=t}),e}hasQueryParam(e){return this._params.has(e)}reqQueryParams(...e){let t={};return e.forEach((r)=>{t[r]=this._params.get(r)??null}),t}}class C{headers;_response=null;headerObjectCache=null;constructor(){this.headers=new Headers}headersToObject(e){let t={};return e.forEach((r,s)=>{t[s]=r}),t}json(e,t={}){if(e===void 0)return this.badRequest("Invalid data provided");try{let{status:r=200,headers:s={}}=t,n=JSON.stringify(e),i={...this.headersToObject(this.headers),"Content-Type":"application/json",...s};return this._response=new Response(n,{status:r,headers:i}),this._response}catch(r){return console.error("Error in json response:",r),this.serverError("Error processing JSON response")}}text(e,t={}){let{status:r=200,headers:s={}}=t,n={...this.headersToObject(this.headers),"Content-Type":"text/plain",...s};try{return this._response=new Response(e,{status:r,headers:n}),this._response}catch(i){return console.error("Error in text response:",i),this.serverError("Error processing text response")}}html(e,t={}){try{let{status:r=200,headers:s={}}=t,n={...this.headersToObject(this.headers),"Content-Type":"text/html",...s};return this._response=new Response(e,{status:r,headers:n}),this._response}catch(r){return console.error("Error in html response:",r),this.serverError("Error processing html response")}}redirect(e,t={}){let{status:r=302,headers:s={}}=t,n={...this.headersToObject(this.headers),Location:e,...s};return this._response=new Response(null,{status:r,headers:n}),this._response}notFound(e="404 Not Found",t={}){let{status:r=404,headers:s={}}=t,n=e,i={...this.headersToObject(this.headers),"Content-Type":"text/plain",...s};return this._response=new Response(n,{status:r,headers:i}),this._response}badRequest(e="Bad Request",t={}){return this.text(e,{...t,status:400})}serverError(e="Internal Server Error",t={}){return console.error({type:"ServerError",message:e,timestamp:new Date().toISOString(),requestId:crypto.randomUUID()}),this.text(e,{...t,status:500})}created(e,t={}){let{status:r=201,headers:s={}}=t,n=JSON.stringify(e),i={...this.headersToObject(this.headers),"Content-Type":"application/json",...s};return this._response=new Response(n,{status:r,headers:i}),this._response}noContent(e={}){let{status:t=204,headers:r={}}=e,s={...this.headersToObject(this.headers),"Content-Type":"text/plain",...r};try{return this._response=new Response(null,{status:t,headers:s}),this._response}catch(n){throw console.error("Failed to create response for no content:",n),new Error("Unable to create response no content")}}file(e,t,r={}){let{status:s=200,headers:n={}}=r,i={...this.headersToObject(this.headers),"Content-Disposition":`attachment; filename="${encodeURIComponent(t)}"`,...n};if(!e)i["Content-Type"]="application/octet-stream";try{return this._response=new Response(e,{status:s,headers:i}),this._response}catch(o){throw console.error("Failed to create response for file:",o),new Error("Unable to create response file")}}formData(e,t={}){let{status:r=200,headers:s={}}=t,n={"Content-Type":"application/x-www-form-urlencoded",...this.headersToObject(this.headers),...s};try{return this._response=new Response(e,{status:r,headers:n}),this._response}catch(i){throw console.error("Failed to create response for form data:",i),new Error("Unable to create response form data")}}stream(e,t={}){let{status:r=200,headers:s={}}=t,n={"Content-Type":"application/octet-stream",...this.headersToObject(this.headers),...s};try{return this._response=new Response(e,{status:r,headers:n}),this._response}catch(i){throw console.error("Failed to create response for stream:",i),new Error("Unable to create response stream")}}setCookie(e,t,r={}){let s=Object.assign({path:"/",httpOnly:!0,secure:!0,sameSite:"Lax"},r),n=this.serializeCookie(e,t,s);try{this.appendHeader("Set-Cookie",n)}catch(i){console.error("Failed to set cookie:",i)}}delCookie(e,t={}){this.setCookie(e,"",{...t,maxAge:0})}updateResponseHeaders(){if(this._response)this._response=new Response(this._response.body,{status:this._response.status,statusText:this._response.statusText,headers:new Headers(this.headers)})}appendHeader(e,t){this.headers.append(e,t),this.updateResponseHeaders()}setHeader(e,t){this.headers.set(e,t),this.updateResponseHeaders()}getHeader(e){return this.headers.get(e)??this._response?.headers.get(e)??null}getAllHeaders(){if(!this.headerObjectCache)this.headerObjectCache={},this.headers.forEach((e,t)=>{this.headerObjectCache[t]=e});return{...this.headerObjectCache}}removeHeader(e){if(this.headers.delete(e),this._response){let t=new Headers(this._response.headers);t.delete(e),this._response=new Response(this._response.body,{status:this._response.status,statusText:this._response.statusText,headers:t})}}setResponse(e){this._response=e,e.headers.forEach((t,r)=>{this.headers.set(r,t)})}getResponse(){return this._response}updateResponse(e){if(this._response)this._response=new Response(this._response.body,{status:e.status,statusText:e.statusText,headers:this.headers}),e.headers.forEach((t,r)=>{this.headers.set(r,t)});else this.setResponse(e)}serializeCookie(e,t,r){let s=`${e}=${encodeURIComponent(t)}`;if(r.maxAge!==void 0)s+=`; Max-Age=${r.maxAge}`;if(r.domain)s+=`; Domain=${r.domain}`;if(s+=`; Path=${r.path}`,r.secure)s+="; Secure";if(r.httpOnly)s+="; HttpOnly";if(r.sameSite)s+=`; SameSite=${r.sameSite}`;if(r.expires)s+=`; Expires=${r.expires.toUTCString()}`;return s}}var L=globalThis.Bun;class p{transpiler;cachedComponents=new WeakMap;propsCache=new WeakMap;static EMPTY_RESULT="";static VOID_ELEMENTS=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]);constructor(e){this.transpiler=new L.Transpiler({loader:"jsx",target:"browser",minifyWhitespace:!0,...e})}renderJSX(e){try{if(typeof e.type==="function")return this.renderComponent(e.type,{...e.props,children:e.children});return this.jsx(e.type,e.props,...e.children)}catch{return p.EMPTY_RESULT}}renderComponent(e,t){try{return e(t)}catch{return p.EMPTY_RESULT}}createComponent(e){let t=this.cachedComponents.get(e);if(t)return t;let r=(s)=>this.renderComponent(e,s);return this.cachedComponents.set(e,r),r}transpileJSX(e){try{return this.transpiler.transformSync(e)}catch{throw new Error("JSX transpilation failed")}}propsToString(e){if(!e)return p.EMPTY_RESULT;let t=this.propsCache.get(e);if(t)return t;let r=Object.entries(e).filter(([s,n])=>n!=null).map(([s,n])=>` ${s}={${JSON.stringify(n)}}`).join("");return this.propsCache.set(e,r),r}flattenChildren(e){return e.flat().filter(Boolean)}jsx=(e,t,...r)=>{try{if(typeof e==="function")return this.renderComponent(e,{...t,children:this.flattenChildren(r)});let s=this.flattenChildren(r),i=typeof e==="string"&&p.VOID_ELEMENTS.has(e)?`<${e}${this.propsToString(t)} />`:`<${e}${this.propsToString(t)}>${s.join("")}</${e}>`;return this.transpileJSX(i)}catch{return p.EMPTY_RESULT}}}class H{req;res;params;locals;transpiler;constructor(e){this.req=new S(e),this.res=new C,this.params={},this.locals=new Map,this.transpiler=new p}renderJSX(e){return this.transpiler.renderJSX(e)}createComponent(e){return this.transpiler.createComponent(e)}jsx(e,t,...r){let s=this.transpiler.jsx(e,t,...r);return new Response(s,{headers:{"Content-Type":"text/html"}})}set(e,t){h(e),this.locals.set(e,t)}get(e){if(h(e),this.has(e))return this.locals.get(e);return}has(e){return h(e),this.locals.has(e)}delete(e){if(h(e),this.locals.has(e))this.locals.delete(e)}getAll(){return new Map(this.locals)}setParam(e,t){this.params[e]=t}setParams(e){this.params=e}getParam(e){return this.params[e]}getAllParams(){return this.params}getResponse(){return this.res.getResponse()}setResponse(e){return this.res.setResponse(e),this}updateResponse(e){this.res.updateResponse(e)}getMethod(){return this.req.method}getUrl(){return this.req.url}getHeaders(){return this.req.headers}reqHasHeader(e){return this.req.reqHasHeader(e)}reqHeader(e){return this.req.reqHeader(e)}reqAllHeaders(){return this.req.reqAllHeaders()}reqJson(){return this.req.reqJson()}reqText(){return this.req.reqText()}reqBlob(){return this.req.reqBlob()}reqFormData(){return this.req.reqFormData()}hasBody(){return this.req.hasBody()}isJson(){return this.req.isJson()}isFormData(){return this.req.isFormData()}param(e){return this.req.param(e)}query(){return this.req.query()}hasQueryParam(e){return this.req.hasQueryParam(e)}reqQueryParams(...e){return this.req.reqQueryParams(...e)}json(e,t){let r=this.res.json(e,t);return this.setResponse(r),r}text(e,t){let r=this.res.text(e,t);return this.setResponse(r),r}html(e,t){let r=this.res.html(e,t);return this.setResponse(r),r}redirect(e,t){let r=this.res.redirect(e,t);return this.setResponse(r),r}notFound(e="404 Not Found",t){let r=this.res.notFound(e,t);return this.setResponse(r),r}badRequest(e="Bad Request"){let t=this.res.badRequest(e);return this.setResponse(t),t}serverError(e="Internal Server Error"){let t=this.res.serverError(e);return this.setResponse(t),t}created(e,t){let r=this.res.created(e,t);return this.setResponse(r),r}file(e,t,r){let s=this.res.file(e,t,r);return this.setResponse(s),s}formData(e,t){let r=this.res.formData(e,t);return this.setResponse(r),r}stream(e,t){let r=this.res.stream(e,t);return this.setResponse(r),r}setCookie(e,t,r){this.res.setCookie(e,t,r)}getCookie(e){return this.req.getCookie(e)}delCookie(e,t){this.res.delCookie(e,t)}appendHeader(e,t){this.res.appendHeader(e,t)}setHeader(e,t){this.res.setHeader(e,t)}getHeader(e){return this.res.getHeader(e)}getAllHeaders(){return this.res.getAllHeaders()}removeHeader(e){this.res.removeHeader(e)}noContent(e){let t=this.res.noContent(e);return this.setResponse(t),t}}async function E(e,t,r){let s=new H(e);try{if(await r.runMiddlewares(s),!s.getResponse()){let i=new URL(e.url),o=await t.handleRequest(i.pathname,e.method,s);if(o instanceof Response)s.setResponse(o);else if(o===void 0)s.setResponse(s.notFound())}let n=s.getResponse();if(s.getMethod()==="HEAD")return new Response(null,{status:n.status,headers:n.headers});return n}catch(n){return console.error("Unhandled error:",n),s.serverError()}}class m{middlewares=new Map;use(e,...t){let r=typeof e==="string"?e:"/",s=typeof e==="string"?t:[e,...t];if(s.length===0)throw new Error("No valid middleware provided");if(!this.middlewares.has(r))this.middlewares.set(r,[]);return this.middlewares.get(r).push(...s),this}group(...e){return async(t,r)=>{let s=-1,n=async(i)=>{if(i<=s)throw new Error("next() called multiple times");s=i;let o=e[i];if(o)await o(t,()=>n(i+1));else await r()};await n(0)}}useWhen(e,...t){let r=async(s,n)=>{if(e(s))await this.group(...t)(s,n);else await n()};return this.use(r)}createNext(e){let t=new URL(e.getUrl()).pathname,r=Array.from(this.middlewares.keys()).filter((o)=>t.startsWith(o)).sort((o,d)=>d.length-o.length),s=0,n=0,i=async()=>{while(s<r.length){let o=r[s],d=this.middlewares.get(o);if(n<d.length){let u=d[n];n++,await u(e,i);return}s++,n=0}};return i}getMiddlewares(){let e=[];for(let[t,r]of this.middlewares)for(let s of r)e.push({path:t,handler:s});return e}async runMiddlewares(e){await this.createNext(e)()}}var _={".html":"text/html",".htm":"text/html",".md":"text/markdown",".txt":"text/plain",".xml":"application/xml",".json":"application/json",".map":"application/json",".csv":"text/csv",".css":"text/css",".js":"application/javascript",".mjs":"application/javascript",".ts":"application/typescript",".wasm":"application/wasm",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".bmp":"image/bmp",".svg":"image/svg+xml",".ico":"image/x-icon",".webp":"image/webp",".avif":"image/avif",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".ogg":"audio/ogg",".mp4":"video/mp4",".m4v":"video/x-m4v",".webm":"video/webm",".woff":"font/woff",".woff2":"font/woff2",".ttf":"font/ttf",".otf":"font/otf",".zip":"application/zip",".tar":"application/x-tar",".gz":"application/gzip",".rar":"application/vnd.rar",".7z":"application/x-7z-compressed",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation"},X=_;import{join as R,extname as V}from"path";function B(e,t,r,s={}){let{spa:n=!1,index:i="index.html",maxAge:o=0,immutable:d=!1}=s,u=R(e,r),f=()=>{let a=[`max-age=${o}`];if(d)a.push("immutable");return a.join(", ")},O=(a)=>{return Bun.file(a).stream().pipeThrough(new TransformStream)},N=async(a)=>{if(a.getMethod()!=="GET"&&a.getMethod()!=="HEAD")return a.notFound();let w=new URL(a.getUrl()),l=R(u,w.pathname.substring(t.length));if(l.endsWith("/")||!await Bun.file(l).exists()){if(l=R(l,i),!await Bun.file(l).exists())if(n)l=R(u,i);else return a.notFound()}let T=Bun.file(l),j=V(l).toLowerCase(),A=X[j]||"application/octet-stream",y=new Headers({"Content-Type":A,"Content-Length":T.size.toString(),"Cache-Control":f(),ETag:`W/"${T.size.toString(16)}-${T.lastModified.toString(16)}"`});if(a.getHeader("if-none-match")===y.get("ETag"))return new Response(null,{status:304,headers:y});let U=O(l);return new Response(U,{status:200,headers:y})};return async(a,w)=>{if(a.getMethod()==="GET"||a.getMethod()==="HEAD"){let l=await N(a);if(l.status!==404){a.setResponse(l);return}}await w()}}class q{router;middlewareHandler=new m;baseDir;constructor(){this.router=new M,this.middlewareHandler=new m,this.baseDir=process.cwd()}addRoute(e,t,...r){let s=r.slice(0,-1),n=r[r.length-1];return this.router.addRoute(e,t,n,s),this}handleRouteHandler(e){let t=Object.keys(e);for(let r of t){let s=e[r];if(Array.isArray(s)){let[n,...i]=s;this.addRoute(r,n,...i)}else if(typeof s==="string")this.addRoute(r,s,()=>new Response("Not Implemented",{status:501}))}}async handleRequest(e){return E(e,this.router,this.middlewareHandler)}static(e,t,r={}){let s=B(this.baseDir,e,t,r);return this.middlewareHandler.use(e,s),this}use(e,...t){return this.middlewareHandler.use(e,...t),this}group(...e){return this.middlewareHandler.group(...e)}useWhen(e,...t){return this.middlewareHandler.useWhen(e,...t),this}route(e,...t){if(t.length===0)throw new Error("No sub app provided");let r=c(e);return t.forEach((s)=>{if(!(s instanceof q))throw new Error("Sub app is not an instance of Bunzai");s.router.getRoutes().forEach((n)=>{let i=c(r,n.originalPath);this.router.addRoute(n.method,i,n.handler,n.middleware||[])}),s.middlewareHandler.getMiddlewares().forEach((n)=>{let i=c(r,n.path);this.middlewareHandler.use(i,n.handler)})}),this}routeHandler(e){return this.handleRouteHandler(e),this}get(e,...t){return this.addRoute("GET",e,...t)}post(e,...t){return this.addRoute("POST",e,...t)}put(e,...t){return this.addRoute("PUT",e,...t)}patch(e,...t){return this.addRoute("PATCH",e,...t)}delete(e,...t){return this.addRoute("DELETE",e,...t)}head(e,...t){return this.addRoute("HEAD",e,...t)}options(e,...t){return this.addRoute("OPTIONS",e,...t)}async listen(e=3000,t="localhost",r,s){return v(this,e,t,r,s)}}export{q as Bunzai};export{q as a};
